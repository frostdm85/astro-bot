<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê—Å—Ç—Ä–æ-–ø—Ä–æ–≥–Ω–æ–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/webapp/css/style.css?v=20">
</head>
<body>
    <!-- ============== –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò ============== -->
    <div id="loading" class="screen active">
        <div class="loader"></div>
        <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –û–®–ò–ë–ö–ò ============== -->
    <div id="error" class="screen">
        <div class="error-container">
            <div class="error-emoji">‚ö†Ô∏è</div>
            <div class="error-title" id="errorTitle">–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
            <div class="error-text" id="errorText">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</div>
            <div class="error-buttons" style="margin-top: 24px; display: flex; gap: 12px; flex-direction: column;">
                <button class="menu-item" id="retryBtn" onclick="retryLastAction()" style="display: none; padding: 16px; font-size: 16px;" aria-label="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ">
                    üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
                <button class="menu-item" onclick="showScreen('menu')" style="padding: 16px; font-size: 16px;" aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
                    üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <!-- ============== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ============== -->
    <div id="menu" class="screen">
        <div class="menu-header">
            <img src="/webapp/img/logo.svg" alt="–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è" class="menu-logo">
            <div class="menu-title">–í–∞—à –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑</div>
            <div class="menu-subtitle" id="menuUserName"></div>
        </div>

        <!-- –ú–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π -->
        <div class="menu-calendar-section">
            <div class="calendar-hint">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
            <div class="menu-calendar-header">
                <button id="menuCalPrev" class="mini-nav-btn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Üê</button>
                <div id="menuCalMonthYear" class="menu-month-year">–Ø–Ω–≤–∞—Ä—å 2026</div>
                <button id="menuCalNext" class="mini-nav-btn" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Üí</button>
            </div>
            <div class="menu-calendar-weekdays">
                <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
            </div>
            <div id="menuCalendarGrid" class="menu-calendar-grid">
                <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
            </div>
            <div class="menu-calendar-legend">
                <span class="legend-item"><span class="legend-dot good"></span>–•–æ—Ä–æ—à–∏–π</span>
                <span class="legend-item"><span class="legend-dot neutral"></span>–û–±—ã—á–Ω—ã–π</span>
                <span class="legend-item"><span class="legend-dot difficult"></span>–°–ª–æ–∂–Ω—ã–π</span>
            </div>
        </div>

        <div class="menu-grid compact">
            <button class="menu-item primary" id="btnForecastToday">
                <span class="menu-icon">‚ú®</span>
                <div class="menu-label-group">
                    <span class="menu-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</span>
                    <span class="menu-desc">–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–Ω—è</span>
                </div>
            </button>

            <button class="menu-item" id="btnSettings">
                <span class="menu-icon">‚öôÔ∏è</span>
                <div class="menu-label-group">
                    <span class="menu-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    <span class="menu-desc">–í—Ä–µ–º—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                </div>
            </button>

            <button class="menu-item" id="btnSupport">
                <span class="menu-icon">üí¨</span>
                <div class="menu-label-group">
                    <span class="menu-label">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                    <span class="menu-desc">–°–≤—è–∑—å —Å –∞—Å—Ç—Ä–æ–ª–æ–≥–æ–º</span>
                </div>
            </button>
        </div>

        <!-- –ë–ª–æ–∫ –ù–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã -->
        <div class="natal-widget">
            <div class="natal-widget-header">
                <span class="natal-widget-icon">üåå</span>
                <span class="natal-widget-title">–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞</span>
            </div>
            <div class="natal-widget-content">
                <div id="menuChartPaper" class="menu-chart-paper"></div>
                <div id="menuChartLegend" class="menu-chart-legend"></div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –õ—É–Ω—ã -->
        <div class="moon-widget">
            <div class="moon-widget-header">
                <span class="moon-widget-icon">üåô</span>
                <span class="moon-widget-title">–õ—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</span>
            </div>
            <div class="moon-widget-content">
                <div class="moon-visual">
                    <div class="moon-sphere" id="moonSphere">
                        <div class="moon-shadow" id="moonShadow"></div>
                    </div>
                    <div class="moon-glow"></div>
                </div>
                <div class="moon-info">
                    <div class="moon-phase-name" id="moonPhaseName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="moon-details">
                        <span class="moon-day" id="moonDay">‚Äî</span>
                        <span class="moon-sign" id="moonSign">‚Äî</span>
                    </div>
                    <div class="moon-illumination">
                        <div class="illumination-bar">
                            <div class="illumination-fill" id="moonIllumination"></div>
                        </div>
                        <span class="illumination-text" id="moonIlluminationText">0%</span>
                    </div>
                </div>
            </div>
            <div class="moon-events">
                <div class="moon-event">
                    <span class="event-emoji">üåë</span>
                    <div class="event-info">
                        <span class="event-name">–ù–æ–≤–æ–ª—É–Ω–∏–µ</span>
                        <span class="event-date" id="nextNewMoon">‚Äî</span>
                    </div>
                </div>
                <div class="moon-event">
                    <span class="event-emoji">üåï</span>
                    <div class="event-info">
                        <span class="event-name">–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ</span>
                        <span class="event-date" id="nextFullMoon">‚Äî</span>
                    </div>
                </div>
                <div class="moon-event eclipse-event" id="eclipseEvent1" style="display: none;">
                    <span class="event-emoji" id="eclipseEmoji1">üåï</span>
                    <div class="event-info">
                        <span class="event-name" id="eclipseType1">–ó–∞—Ç–º–µ–Ω–∏–µ</span>
                        <span class="event-date" id="eclipseDate1">‚Äî</span>
                    </div>
                </div>
                <div class="moon-event eclipse-event" id="eclipseEvent2" style="display: none;">
                    <span class="event-emoji" id="eclipseEmoji2">üåï</span>
                    <div class="event-info">
                        <span class="event-name" id="eclipseType2">–ó–∞—Ç–º–µ–Ω–∏–µ</span>
                        <span class="event-date" id="eclipseDate2">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –†–µ—Ç—Ä–æ–≥—Ä–∞–¥–æ–≤ -->
        <div class="retrograde-widget">
            <div class="retrograde-header">
                <span class="retrograde-icon">üîÑ</span>
                <span class="retrograde-title">–†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã</span>
                <span class="retrograde-year" id="retrogradeYear">2026</span>
            </div>

            <!-- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å -->
            <div class="retrograde-status" id="retrogradeStatus">
                <span class="status-label">–°–µ–π—á–∞—Å –≤ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–µ:</span>
                <span class="status-value" id="currentRetrogrades">‚Äî</span>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–µ—Ç —Å –ø–µ—Ä–∏–æ–¥–∞–º–∏ -->
            <div class="retrograde-list" id="retrogradeList">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <!-- –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ -->
        <div class="user-info-card">
            <div class="user-info-header">
                <span class="user-info-icon">üìã</span>
                <span class="user-info-title">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</span>
            </div>
            <div class="user-info-grid">
                <div class="user-info-item">
                    <span class="info-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</span>
                    <span class="info-value" id="menuBirthDate">‚Äî</span>
                </div>
                <div class="user-info-item">
                    <span class="info-label">–í—Ä–µ–º—è</span>
                    <span class="info-value" id="menuBirthTime">‚Äî</span>
                </div>
                <div class="user-info-item">
                    <span class="info-label">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è</span>
                    <span class="info-value" id="menuBirthPlace">‚Äî</span>
                </div>
                <div class="user-info-item">
                    <span class="info-label">–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ</span>
                    <span class="info-value" id="menuResidence">‚Äî</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –ü–†–û–ì–ù–û–ó–ê ============== -->
    <div id="forecast" class="screen">
        <div class="screen-header">
            <button class="back-btn" id="forecastBack" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">‚Üê</button>
            <div class="header-title">–ü—Ä–æ–≥–Ω–æ–∑</div>
            <div class="header-spacer"></div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º -->
        <div class="date-header">
            <button id="prevDay" class="nav-btn ripple" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚Üê</button>
            <div class="date-info">
                <div id="dayName" class="day-name">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
                <div id="dateText" class="date-text">12 —è–Ω–≤–∞—Ä—è 2026</div>
            </div>
            <button id="nextDay" class="nav-btn ripple" aria-label="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚Üí</button>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–Ω—è -->
        <div id="moodCard" class="mood-card neutral">
            <div id="moodEmoji" class="mood-emoji">üòä</div>
            <div id="moodTitle" class="mood-title">–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å</div>
            <div id="moodSubtitle" class="mood-subtitle">–ù–µ—Ç –æ—Å–æ–±—ã—Ö —É–∫–∞–∑–∞–Ω–∏–π</div>
        </div>

        <!-- –¢–µ–∫—Å—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
        <div class="forecast-section">
            <div class="section-header">
                <span class="section-icon">‚ú®</span>
                <span class="section-title">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å</span>
            </div>
            <div id="forecastText" class="forecast-text">
                –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞...
            </div>
        </div>

        <!-- –í–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É -->
        <div class="question-section">
            <div class="section-header">
                <span class="section-icon">üí¨</span>
                <span class="section-title">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</span>
            </div>
            <div class="question-container">
                <div id="questionHistory" class="question-history"></div>
                <div class="question-input-wrapper">
                    <input type="text" id="questionInput" class="question-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ –ø—Ä–æ–≥–Ω–æ–∑–µ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å..." aria-label="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                    <button id="sendQuestion" class="send-btn ripple" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å">
                        <span class="send-icon">‚Üí</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- –¢—Ä–∞–Ω–∑–∏—Ç—ã -->
        <div id="transitsSection" class="timeline-section">
            <div class="section-header">
                <span class="section-icon">üåü</span>
                <span class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–ª–∏—è–Ω–∏—è</span>
            </div>
            <div id="transitsList" class="timeline">
                <!-- –¢—Ä–∞–Ω–∑–∏—Ç—ã -->
            </div>
        </div>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –ö–ê–õ–ï–ù–î–ê–†–Ø ============== -->
    <div id="calendar" class="screen">
        <div class="screen-header">
            <button class="back-btn" id="calendarBack" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">‚Üê</button>
            <div class="header-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
            <div class="header-spacer"></div>
        </div>

        <div class="calendar-nav">
            <button id="calPrev" class="nav-btn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Üê</button>
            <div id="calMonthYear" class="month-year">–Ø–Ω–≤–∞—Ä—å 2026</div>
            <button id="calNext" class="nav-btn" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Üí</button>
        </div>

        <div class="calendar-weekdays">
            <span>–ü–Ω</span>
            <span>–í—Ç</span>
            <span>–°—Ä</span>
            <span>–ß—Ç</span>
            <span>–ü—Ç</span>
            <span>–°–±</span>
            <span>–í—Å</span>
        </div>

        <div id="calendarGrid" class="calendar-grid">
            <!-- –î–Ω–∏ -->
        </div>

        <div class="legend">
            <div class="legend-item">
                <span class="legend-dot good"></span>
                <span>–•–æ—Ä–æ—à–æ</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot neutral"></span>
                <span>–û–±—ã—á–Ω–æ</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot difficult"></span>
                <span>–°–ª–æ–∂–Ω–æ</span>
            </div>
        </div>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö ============== -->
    <div id="settings" class="screen">
        <div class="screen-header">
            <button class="back-btn" id="settingsBack" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">‚Üê</button>
            <div class="header-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="header-spacer"></div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">–£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑</div>
            <div class="settings-section-desc">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤–∞–º –ø—Ä–∏–¥—ë—Ç –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å</div>
            <div class="settings-item toggle-item">
                <div class="settings-label">–ü–æ–ª—É—á–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</div>
                <label class="toggle">
                    <input type="checkbox" id="forecastToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div class="settings-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
                <div class="settings-value" id="forecastTimeValue">09:00</div>
            </div>
            <div class="time-picker" id="timePicker">
                <button class="time-btn" data-time="06:00">06:00</button>
                <button class="time-btn" data-time="07:00">07:00</button>
                <button class="time-btn" data-time="08:00">08:00</button>
                <button class="time-btn selected" data-time="09:00">09:00</button>
                <button class="time-btn" data-time="10:00">10:00</button>
                <button class="time-btn" data-time="11:00">11:00</button>
                <button class="time-btn" data-time="12:00">12:00</button>
                <button class="time-btn" data-time="20:00">20:00</button>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">–í–∞–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã</div>
            <div class="settings-section-desc">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–Ω–∞—á–∏–º—ã—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ (–ø–ª–∞–Ω–µ—Ç—ã –∫—Ä–æ–º–µ –õ—É–Ω—ã –∏ –°–æ–ª–Ω—Ü–∞)</div>
            <div class="settings-item toggle-item">
                <div class="settings-label">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <label class="toggle">
                    <input type="checkbox" id="notificationsToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –ü–û–î–î–ï–†–ñ–ö–ò ============== -->
    <div id="support" class="screen">
        <div class="screen-header">
            <button class="back-btn" id="supportBack" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">‚Üê</button>
            <div class="header-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
            <div class="header-spacer"></div>
        </div>

        <div class="support-content">
            <div class="support-card">
                <div class="support-icon">üë®‚Äçüíª</div>
                <div class="support-title">–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞—Å—Ç—Ä–æ–ª–æ–≥–æ–º</div>
                <div class="support-text">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</div>
                <button class="support-btn" id="btnContactAstro">–ù–∞–ø–∏—Å–∞—Ç—å</button>
            </div>

            <div class="support-card">
                <div class="support-icon">‚ùì</div>
                <div class="support-title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</div>
                <div class="support-text">
                    –ü—Ä–æ–≥–Ω–æ–∑—ã —Å—Ç—Ä–æ—è—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –ø–ª–∞–Ω–µ—Ç –∫ –≤–∞—à–µ–π –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ.
                    –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∞—Å–ø–µ–∫—Ç—ã –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–º–∏ –∏ –Ω–∞—Ç–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞–Ω–µ—Ç–∞–º–∏, —á—Ç–æ –¥–∞—ë—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
                </div>
            </div>

            <div class="support-card">
                <div class="support-icon">üìñ</div>
                <div class="support-title">–û –ø—Ä–æ–≥–Ω–æ–∑–∞—Ö</div>
                <div class="support-text">
                    –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç. –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã (—Ç—Ä–∏–≥–æ–Ω, —Å–µ–∫—Å—Ç–∏–ª—å) ‚Äî –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã, –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–µ (–∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞, –æ–ø–ø–æ–∑–∏—Ü–∏—è) ‚Äî —Ç—Ä–µ–±—É—é—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏.
                </div>
            </div>
        </div>
    </div>

    <!-- ============== –≠–ö–†–ê–ù –ù–ê–¢–ê–õ–¨–ù–û–ô –ö–ê–†–¢–´ ============== -->
    <div id="natalChart" class="screen">
        <div class="screen-header">
            <button class="back-btn" id="natalChartBack" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">‚Üê</button>
            <div class="header-title">–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
            <div class="header-spacer"></div>
        </div>

        <div class="natal-chart-container">
            <div class="chart-user-info" id="chartUserInfo">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            </div>
            <div id="chartPaper" class="chart-paper">
                <div class="chart-loading">
                    <div class="loader-small"></div>
                    <span>–°—Ç—Ä–æ—é –∫–∞—Ä—Ç—É...</span>
                </div>
            </div>
            <div class="chart-legend" id="chartLegend">
                <!-- –õ–µ–≥–µ–Ω–¥–∞ –ø–ª–∞–Ω–µ—Ç -->
            </div>
        </div>
    </div>

    <script src="/webapp/js/astrochart2.js"></script>
    <script>
    /**
     * –ê–°–¢–†–û-–ë–û–¢ MINI APP
     * –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
     */

    // ============== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==============

    const tg = window.Telegram?.WebApp;

    // –ü–æ–ª—É—á–∞–µ–º user_id
    let userId = null;
    let userData = null;

    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        userId = tg.initDataUnsafe.user.id;
        userData = tg.initDataUnsafe.user;
    }

    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('user_id')) {
        userId = parseInt(urlParams.get('user_id'));
    }

    // –¢–µ–∫—É—â–∏–µ –¥–∞—Ç—ã
    let currentDate = new Date();
    let currentCalendarMonth = new Date();
    const calendarCache = new Map(); // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ –º–µ—Å—è—Ü–∞–º

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const planetSymbols = {
        '–°–æ–ª–Ω—Ü–µ': '‚òâ', '–õ—É–Ω–∞': '‚òΩ', '–ú–µ—Ä–∫—É—Ä–∏–π': '‚òø', '–í–µ–Ω–µ—Ä–∞': '‚ôÄ',
        '–ú–∞—Ä—Å': '‚ôÇ', '–Æ–ø–∏—Ç–µ—Ä': '‚ôÉ', '–°–∞—Ç—É—Ä–Ω': '‚ôÑ', '–£—Ä–∞–Ω': '‚ôÖ',
        '–ù–µ–ø—Ç—É–Ω': '‚ôÜ', '–ü–ª—É—Ç–æ–Ω': '‚ôá', '–õ–∏–ª–∏—Ç': '‚ö∏', '–°–µ–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª': '‚òä'
    };

    const moodEmoji = { good: 'üòä', neutral: 'üòå', difficult: 'üåä' };
    const moodTitle = { good: '–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å', neutral: '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å', difficult: '–ù–µ–ø—Ä–æ—Å—Ç–æ–π –¥–µ–Ω—å' };
    const moodSubtitle = {
        good: '–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –≤–ª–∏—è–Ω–∏—è',
        neutral: '–ù–µ—Ç –æ—Å–æ–±—ã—Ö —É–∫–∞–∑–∞–Ω–∏–π',
        difficult: '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏'
    };

    const monthNames = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];

    // ============== –ó–ê–ü–£–°–ö ==============

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Mini App –∑–∞–ø—É—â–µ–Ω');
        console.log('üë§ User ID:', userId);

        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();
        }

        if (!userId) {
            showError('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –ø–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ –ë–î
        let userName = '';
        try {
            const response = await fetch(`/api/user/${userId}/check`);
            if (response.status === 404) {
                showError('–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                return;
            }
            if (response.status === 400) {
                showError('–ù–∞—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                return;
            }
            if (response.ok) {
                const data = await response.json();
                userName = data.name || '';
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ–∫–∞–∂–µ–º –º–µ–Ω—é
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        setupNavigation();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è: –∏–∑ –ë–î > –∏–∑ Telegram > –ø—É—Å—Ç–æ
        const displayName = userName || (userData?.first_name) || '';
        if (displayName) {
            document.getElementById('menuUserName').textContent = displayName;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º hash –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —ç–∫—Ä–∞–Ω—É
        const hash = window.location.hash;
        if (hash === '#settings') {
            loadSettings();
            showScreen('settings');
        } else {
            showScreen('menu');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∞ "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ" –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
            loadSettings();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
            loadMenuNatalChart();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –õ—É–Ω–µ
            loadMoonInfo();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–∞—Ö
            loadRetrogrades();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        currentCalendarMonth = new Date();
        loadMenuCalendar();
    });

    // ============== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==============

    function setupNavigation() {
        // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        document.getElementById('btnForecastToday').onclick = () => {
            currentDate = new Date();
            loadForecast(currentDate);
            haptic('medium');
        };

        document.getElementById('btnSettings').onclick = () => {
            loadSettings();
            showScreen('settings');
            haptic('light');
        };

        document.getElementById('btnSupport').onclick = () => {
            showScreen('support');
            haptic('light');
        };

        // –ö–ª–∏–∫ –ø–æ –≤–∏–¥–∂–µ—Ç—É –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
        document.querySelector('.natal-widget')?.addEventListener('click', () => {
            showScreen('natalChart');
            loadNatalChart();
            haptic('light');
        });

        // –ú–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        document.getElementById('menuCalPrev').onclick = async () => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            await loadMenuCalendar();
            haptic('light');
        };

        document.getElementById('menuCalNext').onclick = async () => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
            await loadMenuCalendar();
            haptic('light');
        };

        // –ö–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
        document.getElementById('forecastBack').onclick = () => {
            showScreen('menu');
            haptic('light');
        };

        document.getElementById('calendarBack').onclick = () => {
            showScreen('menu');
            haptic('light');
        };

        document.getElementById('settingsBack').onclick = () => {
            showScreen('menu');
            haptic('light');
        };

        document.getElementById('supportBack').onclick = () => {
            showScreen('menu');
            haptic('light');
        };

        document.getElementById('natalChartBack').onclick = () => {
            showScreen('menu');
            haptic('light');
        };

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º –≤ –ø—Ä–æ–≥–Ω–æ–∑–µ
        document.getElementById('prevDay').onclick = async () => {
            currentDate.setDate(currentDate.getDate() - 1);
            await loadForecast(currentDate);
            haptic('light');
        };

        document.getElementById('nextDay').onclick = async () => {
            currentDate.setDate(currentDate.getDate() + 1);
            await loadForecast(currentDate);
            haptic('light');
        };

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        document.getElementById('calPrev').onclick = async () => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            await loadCalendar();
            haptic('light');
        };

        document.getElementById('calNext').onclick = async () => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
            await loadCalendar();
            haptic('light');
        };

        // –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('forecastTimeValue').textContent = btn.dataset.time;
                saveForecastTime(btn.dataset.time);
                haptic('light');
            };
        });

        // –£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –≤–∫–ª/–≤—ã–∫–ª
        document.getElementById('forecastToggle').onchange = (e) => {
            saveForecastEnabled(e.target.checked);
            haptic('light');
        };

        // –í–∞–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –≤–∫–ª/–≤—ã–∫–ª
        document.getElementById('notificationsToggle').onchange = (e) => {
            saveNotificationsSetting(e.target.checked);
            haptic('light');
        };

        // –°–≤—è–∑—å —Å –∞—Å—Ç—Ä–æ–ª–æ–≥–æ–º
        document.getElementById('btnContactAstro').onclick = () => {
            const link = 'https://t.me/dmitrystarkov77';
            if (tg && tg.openTelegramLink) {
                tg.openTelegramLink(link);
            } else {
                window.open(link, '_blank');
            }
            haptic('medium');
        };

        // –í–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É
        document.getElementById('sendQuestion').onclick = () => sendForecastQuestion();
        document.getElementById('questionInput').onkeypress = (e) => {
            if (e.key === 'Enter') {
                sendForecastQuestion();
            }
        };
    }

    // ============== –í–û–ü–†–û–°–´ –ü–û –ü–†–û–ì–ù–û–ó–£ ==============

    let currentForecastSummary = ''; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

    async function sendForecastQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        if (!question) return;

        const historyEl = document.getElementById('questionHistory');
        const sendBtn = document.getElementById('sendQuestion');

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userMsg = document.createElement('div');
        userMsg.className = 'question-item user';
        userMsg.textContent = question;
        historyEl.appendChild(userMsg);

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'question-item assistant loading';
        loadingMsg.textContent = '–î—É–º–∞—é...';
        historyEl.appendChild(loadingMsg);

        // –û—á–∏—â–∞–µ–º –≤–≤–æ–¥ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        input.value = '';
        sendBtn.disabled = true;

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        historyEl.scrollTop = historyEl.scrollHeight;

        haptic('light');

        try {
            const dateStr = currentDate.toLocaleDateString('ru-RU'); // dd.mm.yyyy
            const response = await fetch(`/api/forecast/${userId}/question`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    date_str: dateStr,
                    forecast_context: currentForecastSummary
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const data = await response.json();

            // –ó–∞–º–µ–Ω—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –æ—Ç–≤–µ—Ç
            loadingMsg.className = 'question-item assistant';
            loadingMsg.textContent = data.answer;

            haptic('success');

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–æ–ø—Ä–æ—Å–∞:', e);
            loadingMsg.className = 'question-item assistant';
            loadingMsg.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
            haptic('error');
        } finally {
            sendBtn.disabled = false;
            historyEl.scrollTop = historyEl.scrollHeight;
        }
    }

    function clearQuestionHistory() {
        const historyEl = document.getElementById('questionHistory');
        historyEl.innerHTML = '';
    }

    // ============== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==============

    async function loadForecast(date) {
        showLoading('–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–≥–Ω–æ–∑...');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è retry
        lastAction = () => loadForecast(date);

        const dateStr = formatDateForApi(date);

        try {
            const response = await fetch(`/api/forecast/${userId}/date/${dateStr}`);

            if (response.status === 404) {
                showError('–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', '–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', false);
                return;
            }

            if (response.status === 400) {
                showError('–î–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω—É–∂–Ω—ã –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ä–æ–∂–¥–µ–Ω–∏—è', '–ù–∞—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', false);
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            renderForecast(data);
            showScreen('forecast');
            lastAction = null; // –£—Å–ø–µ—Ö - –æ—á–∏—â–∞–µ–º

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞:', e);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', true);
        }
    }

    async function loadCalendar() {
        const year = currentCalendarMonth.getFullYear();
        const month = currentCalendarMonth.getMonth() + 1;
        const cacheKey = `${year}-${month}`;

        document.getElementById('calMonthYear').textContent = `${monthNames[month - 1]} ${year}`;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
        if (calendarCache.has(cacheKey)) {
            const cachedData = calendarCache.get(cacheKey);
            renderCalendar(cachedData.days, year, month);
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showCalendarLoading(true);

        try {
            const response = await fetch(`/api/forecast/${userId}/calendar?year=${year}&month=${month}`);

            if (!response.ok) {
                renderCalendarWithoutData(year, month);
                return;
            }

            const data = await response.json();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
            calendarCache.set(cacheKey, data);

            renderCalendar(data.days, year, month);

            // –ï—Å–ª–∏ —ç—Ç–æ –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫—ç—à–∞ ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –µ—Å–ª–∏ —Ä–∞—Å—á—ë—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (!data.from_cache) {
                console.log('–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î');
            }

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
            renderCalendarWithoutData(year, month);
        } finally {
            showCalendarLoading(false);
        }
    }

    function showCalendarLoading(show) {
        const grid = document.getElementById('calendarGrid');
        if (show) {
            grid.innerHTML = '<div class="calendar-loading"><div class="loader-small"></div><span>–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –∫–∞–ª–µ–Ω–¥–∞—Ä—å...</span></div>';
        }
    }

    // ============== –ë–õ–û–ö –õ–£–ù–´ ==============

    async function loadMoonInfo() {
        try {
            const response = await fetch('/api/moon');
            if (!response.ok) return;

            const data = await response.json();

            // –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã
            document.getElementById('moonPhaseName').textContent = data.phase_name;

            // –õ—É–Ω–Ω—ã–π –¥–µ–Ω—å –∏ –∑–Ω–∞–∫
            document.getElementById('moonDay').textContent = `${data.lunar_day} –ª—É–Ω–Ω—ã–π –¥–µ–Ω—å`;
            document.getElementById('moonSign').textContent = `${data.moon_sign_symbol} ${data.moon_sign}`;

            // –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
            const illumination = data.illumination || 0;
            document.getElementById('moonIllumination').style.width = `${illumination}%`;
            document.getElementById('moonIlluminationText').textContent = `${Math.round(illumination)}%`;

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–∑—ã
            updateMoonVisual(data.phase_index, data.is_waxing);

            // –î–∞—Ç—ã —Å–æ–±—ã—Ç–∏–π
            document.getElementById('nextNewMoon').textContent = data.next_new_moon;
            document.getElementById('nextFullMoon').textContent = data.next_full_moon;

            // –ó–∞—Ç–º–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ 2-—Ö)
            if (data.eclipses && data.eclipses.length > 0) {
                // –ü–µ—Ä–≤–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ
                const eclipse1 = data.eclipses[0];
                document.getElementById('eclipseEvent1').style.display = 'flex';
                document.getElementById('eclipseEmoji1').textContent = eclipse1.emoji;
                document.getElementById('eclipseType1').textContent = eclipse1.type;
                document.getElementById('eclipseDate1').textContent = eclipse1.date;

                // –í—Ç–æ—Ä–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (data.eclipses.length > 1) {
                    const eclipse2 = data.eclipses[1];
                    document.getElementById('eclipseEvent2').style.display = 'flex';
                    document.getElementById('eclipseEmoji2').textContent = eclipse2.emoji;
                    document.getElementById('eclipseType2').textContent = eclipse2.type;
                    document.getElementById('eclipseDate2').textContent = eclipse2.date;
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –õ—É–Ω–µ:', e);
        }
    }

    function updateMoonVisual(phaseIndex, isWaxing) {
        const moonSphere = document.getElementById('moonSphere');
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Ñ–∞–∑
        moonSphere.className = 'moon-sphere';

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å
        const phaseClasses = [
            'new-moon',          // 0
            'waxing-crescent',   // 1
            'first-quarter',     // 2
            'waxing-gibbous',    // 3
            'full-moon',         // 4
            'waning-gibbous',    // 5
            'last-quarter',      // 6
            'waning-crescent'    // 7
        ];

        if (phaseIndex >= 0 && phaseIndex < phaseClasses.length) {
            moonSphere.classList.add(phaseClasses[phaseIndex]);
        }
    }

    // ============== –†–ï–¢–†–û–ì–†–ê–î–´ ==============

    async function loadRetrogrades() {
        try {
            const response = await fetch('/api/retrogrades');
            if (!response.ok) return;

            const data = await response.json();

            // –ì–æ–¥
            document.getElementById('retrogradeYear').textContent = data.year;

            // –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
            const current = data.current;
            if (current.retrograde_count > 0) {
                const names = current.current_retrogrades.map(p => `${p.symbol} ${p.name}`).join(', ');
                document.getElementById('currentRetrogrades').textContent = names;
                document.getElementById('currentRetrogrades').classList.add('active');
            } else {
                document.getElementById('currentRetrogrades').textContent = '–ù–µ—Ç';
                document.getElementById('currentRetrogrades').classList.remove('active');
            }

            // –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–µ—Ç —Å –ø–µ—Ä–∏–æ–¥–∞–º–∏
            const listEl = document.getElementById('retrogradeList');
            listEl.innerHTML = '';

            for (const planet of data.periods) {
                const planetEl = document.createElement('div');
                planetEl.className = 'retrograde-planet';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–µ –ª–∏ —Å–µ–π—á–∞—Å
                const isCurrentlyRetro = current.current_retrogrades.some(p => p.name === planet.name);

                planetEl.innerHTML = `
                    <div class="planet-header ${isCurrentlyRetro ? 'active' : ''}">
                        <span class="planet-symbol" style="color: ${planet.color}">${planet.symbol}</span>
                        <span class="planet-name">${planet.name}</span>
                        ${isCurrentlyRetro ? '<span class="retro-badge">‚Ñû</span>' : ''}
                    </div>
                    <div class="planet-periods">
                        ${planet.periods.length > 0
                            ? planet.periods.map(p => `
                                <div class="period-item">
                                    <span class="period-dates">${p.start} ‚Äî ${p.end}</span>
                                </div>
                            `).join('')
                            : '<span class="no-periods">–ù–µ—Ç —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–æ–≤ –≤ —ç—Ç–æ–º –≥–æ–¥—É</span>'
                        }
                    </div>
                `;

                listEl.appendChild(planetEl);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–æ–≤:', e);
        }
    }

    // ============== –ù–ê–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê (–í–ò–î–ñ–ï–¢ –ù–ê –ú–ï–ù–Æ) ==============

    let menuChartInstance = null;

    async function loadMenuNatalChart() {
        const chartPaper = document.getElementById('menuChartPaper');
        const chartLegend = document.getElementById('menuChartLegend');

        if (!chartPaper) return;

        chartPaper.innerHTML = '<div class="chart-loading"><div class="loader-small"></div><span>–°—Ç—Ä–æ—é –∫–∞—Ä—Ç—É...</span></div>';
        chartLegend.innerHTML = '';

        try {
            const response = await fetch(`/api/natal-chart/${userId}`);
            if (!response.ok) {
                chartPaper.innerHTML = '<div class="chart-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</div>';
                return;
            }

            const data = await response.json();
            chartPaper.innerHTML = '';

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ (–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ)
            const settings = {
                CHART_PADDING: 5,
                CHART_VIEWBOX_WIDTH: 320,
                CHART_VIEWBOX_HEIGHT: 320,
                RADIX_POINTS_FONT_SIZE: 12,
                RADIX_SIGNS_FONT_SIZE: 10,
                RADIX_AXIS_FONT_SIZE: 8,
                COLOR_BACKGROUND: '#ffffff',
                COLOR_SIGNS_BACKGROUND: 'rgba(139, 92, 246, 0.15)',
                COLOR_POINTS_BACKGROUND: 'rgba(245, 245, 250, 0.95)',
                COLOR_HOUSE_LINES: 'rgba(100, 100, 120, 0.3)',
                COLOR_AXIS_LINE: 'rgba(139, 92, 246, 0.7)',
                COLOR_SIGNS_LINE: 'rgba(100, 100, 120, 0.4)',
                COLOR_SIGNS_SYMBOL: '#333333',
                COLOR_POINTS_SYMBOL: '#1a1a2e',
                COLOR_RETROGRADE_SYMBOL: '#dc2626',
                DRAW_ASPECTS: true,
                COLOR_ASPECT_CONJUNCTION: '#8b5cf6',
                COLOR_ASPECT_SEXTILE: '#22c55e',
                COLOR_ASPECT_SQUARE: '#ef4444',
                COLOR_ASPECT_TRINE: '#3b82f6',
                COLOR_ASPECT_OPPOSITION: '#ef4444',
            };

            const universe = new astrology.Universe('menuChartPaper', settings);
            menuChartInstance = universe.radix();
            menuChartInstance.setData(data);

            // –†–∏—Å—É–µ–º –∞—Å–ø–µ–∫—Ç—ã
            const aspectsConfig = [
                {name: "Conjunction", angle: 0, orb: 8.5},
                {name: "Sextile", angle: 60, orb: 8.5},
                {name: "Square", angle: 90, orb: 8.5},
                {name: "Trine", angle: 120, orb: 8.5},
                {name: "Opposition", angle: 180, orb: 8.5},
            ];
            menuChartInstance.drawAspects(data.points, data.points, aspectsConfig);

            // –ö—Ä–∞—Ç–∫–∞—è –ª–µ–≥–µ–Ω–¥–∞ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –ø–ª–∞–Ω–µ—Ç
            const signSymbols = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l'];
            const planetSymbols = {
                'Sun': 'A', 'Moon': 'B', 'Mercury': 'C', 'Venus': 'D', 'Mars': 'E',
                'Jupiter': 'F', 'Saturn': 'G', 'Uranus': 'H', 'Neptune': 'I', 'Pluto': 'J',
                'NNode': 'K', 'Lilith': 'L'
            };

            let legendHtml = '';
            for (const point of data.points) {
                const signIndex = Math.floor(point.angle / 30);
                const degreeInSign = Math.floor(point.angle % 30);
                const symbol = planetSymbols[point.name] || '?';
                const signSym = signSymbols[signIndex];
                const retro = point.isRetrograde ? '‚Ñû' : '';

                legendHtml += `
                    <div class="menu-legend-item">
                        <span class="menu-legend-symbol">${symbol}</span>
                        <span class="menu-legend-deg">${degreeInSign}¬∞${signSym}${retro}</span>
                    </div>
                `;
            }
            chartLegend.innerHTML = legendHtml;

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã:', e);
            chartPaper.innerHTML = '<div class="chart-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    // ============== –ù–ê–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê (–≠–ö–†–ê–ù) ==============

    let natalChartInstance = null;

    async function loadNatalChart() {
        const chartPaper = document.getElementById('chartPaper');
        const chartUserInfo = document.getElementById('chartUserInfo');
        const chartLegend = document.getElementById('chartLegend');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        chartPaper.innerHTML = '<div class="chart-loading"><div class="loader-small"></div><span>–°—Ç—Ä–æ—é –∫–∞—Ä—Ç—É...</span></div>';
        chartUserInfo.innerHTML = '';
        chartLegend.innerHTML = '';

        try {
            const response = await fetch(`/api/natal-chart/${userId}`);
            if (!response.ok) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã');
            }

            const data = await response.json();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            chartUserInfo.innerHTML = `
                <div class="chart-user-name">${data.user.name}</div>
                <div class="chart-user-details">
                    ${data.user.birth_date} ${data.user.birth_time || ''}<br>
                    ${data.user.birth_place || ''}
                </div>
            `;

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã
            chartPaper.innerHTML = '';

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã (–±–µ–ª—ã–π —Ñ–æ–Ω, —Å–∏—Å—Ç–µ–º–∞ –ö–æ—Ö)
            const settings = {
                CHART_PADDING: 10,
                CHART_VIEWBOX_WIDTH: 400,
                CHART_VIEWBOX_HEIGHT: 400,
                RADIX_POINTS_FONT_SIZE: 14,
                RADIX_SIGNS_FONT_SIZE: 12,
                RADIX_AXIS_FONT_SIZE: 10,
                COLOR_BACKGROUND: '#ffffff',
                COLOR_SIGNS_BACKGROUND: 'rgba(139, 92, 246, 0.15)',
                COLOR_POINTS_BACKGROUND: 'rgba(245, 245, 250, 0.95)',
                COLOR_HOUSE_LINES: 'rgba(100, 100, 120, 0.3)',
                COLOR_AXIS_LINE: 'rgba(139, 92, 246, 0.7)',
                COLOR_SIGNS_LINE: 'rgba(100, 100, 120, 0.4)',
                COLOR_SIGNS_SYMBOL: '#333333',
                COLOR_POINTS_SYMBOL: '#1a1a2e',
                COLOR_RETROGRADE_SYMBOL: '#dc2626',
                // –ê—Å–ø–µ–∫—Ç—ã
                DRAW_ASPECTS: true,
                DEFAULT_ASPECTS: [
                    {name: "Conjunction", angle: 0, orb: 8.5},
                    {name: "Sextile", angle: 60, orb: 8.5},
                    {name: "Square", angle: 90, orb: 8.5},
                    {name: "Trine", angle: 120, orb: 8.5},
                    {name: "Opposition", angle: 180, orb: 8.5},
                ],
                COLOR_ASPECT_CONJUNCTION: '#8b5cf6',  // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
                COLOR_ASPECT_SEXTILE: '#22c55e',      // –°–µ–∫—Å—Ç–∏–ª—å - –∑–µ–ª—ë–Ω—ã–π
                COLOR_ASPECT_SQUARE: '#ef4444',       // –ö–≤–∞–¥—Ä–∞—Ç—É—Ä–∞ - –∫—Ä–∞—Å–Ω—ã–π
                COLOR_ASPECT_TRINE: '#3b82f6',        // –¢—Ä–∏–≥–æ–Ω - —Å–∏–Ω–∏–π
                COLOR_ASPECT_OPPOSITION: '#ef4444',   // –û–ø–ø–æ–∑–∏—Ü–∏—è - –∫—Ä–∞—Å–Ω—ã–π
            };

            // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É
            const universe = new astrology.Universe('chartPaper', settings);
            natalChartInstance = universe.radix();
            natalChartInstance.setData(data);

            // –†–∏—Å—É–µ–º –∞—Å–ø–µ–∫—Ç—ã –≤—Ä—É—á–Ω—É—é —Å –Ω–∞—à–∏–º–∏ –æ—Ä–±–∏—Å–∞–º–∏
            const aspectsConfig = [
                {name: "Conjunction", angle: 0, orb: 8.5},
                {name: "Sextile", angle: 60, orb: 8.5},
                {name: "Square", angle: 90, orb: 8.5},
                {name: "Trine", angle: 120, orb: 8.5},
                {name: "Opposition", angle: 180, orb: 8.5},
            ];
            natalChartInstance.drawAspects(data.points, data.points, aspectsConfig);

            // –°–æ–∑–¥–∞—ë–º –ª–µ–≥–µ–Ω–¥—É
            const planetRu = {
                'Sun': '–°–æ–ª–Ω—Ü–µ', 'Moon': '–õ—É–Ω–∞', 'Mercury': '–ú–µ—Ä–∫—É—Ä–∏–π',
                'Venus': '–í–µ–Ω–µ—Ä–∞', 'Mars': '–ú–∞—Ä—Å', 'Jupiter': '–Æ–ø–∏—Ç–µ—Ä',
                'Saturn': '–°–∞—Ç—É—Ä–Ω', 'Uranus': '–£—Ä–∞–Ω', 'Neptune': '–ù–µ–ø—Ç—É–Ω',
                'Pluto': '–ü–ª—É—Ç–æ–Ω', 'NNode': '–°–µ–≤.–£–∑–µ–ª', 'Lilith': '–õ–∏–ª–∏—Ç'
            };

            const signRu = [
                '–û–≤–µ–Ω', '–¢–µ–ª–µ—Ü', '–ë–ª–∏–∑–Ω–µ—Ü—ã', '–†–∞–∫', '–õ–µ–≤', '–î–µ–≤–∞',
                '–í–µ—Å—ã', '–°–∫–æ—Ä–ø–∏–æ–Ω', '–°—Ç—Ä–µ–ª–µ—Ü', '–ö–æ–∑–µ—Ä–æ–≥', '–í–æ–¥–æ–ª–µ–π', '–†—ã–±—ã'
            ];

            let legendHtml = '<div class="legend-title">–ü–æ–ª–æ–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç</div><div class="legend-items">';
            for (const point of data.points) {
                const signIndex = Math.floor(point.angle / 30);
                const degreeInSign = (point.angle % 30).toFixed(1);
                const ruName = planetRu[point.name] || point.name;
                const ruSign = signRu[signIndex];
                const retroMark = point.isRetrograde ? ' ‚Ñû' : '';

                legendHtml += `
                    <div class="legend-item">
                        <span class="legend-planet">${ruName}${retroMark}</span>
                        <span class="legend-position">${degreeInSign}¬∞ ${ruSign}</span>
                    </div>
                `;
            }
            legendHtml += '</div>';
            chartLegend.innerHTML = legendHtml;

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã:', e);
            chartPaper.innerHTML = `
                <div class="chart-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ä—Ç—É</span>
                    <span class="error-hint">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ä–æ–∂–¥–µ–Ω–∏—è</span>
                </div>
            `;
        }
    }

    // ============== –ú–ò–ù–ò-–ö–ê–õ–ï–ù–î–ê–†–¨ –ù–ê –ì–õ–ê–í–ù–û–ô ==============

    async function loadMenuCalendar() {
        const year = currentCalendarMonth.getFullYear();
        const month = currentCalendarMonth.getMonth() + 1;
        const cacheKey = `${year}-${month}`;

        document.getElementById('menuCalMonthYear').textContent = `${monthNames[month - 1]} ${year}`;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        if (calendarCache.has(cacheKey)) {
            const cachedData = calendarCache.get(cacheKey);
            renderMenuCalendar(cachedData.days, year, month);
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showMenuCalendarLoading(true);

        try {
            const response = await fetch(`/api/forecast/${userId}/calendar?year=${year}&month=${month}`);

            if (!response.ok) {
                renderMenuCalendarEmpty(year, month);
                return;
            }

            const data = await response.json();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            calendarCache.set(cacheKey, data);

            renderMenuCalendar(data.days, year, month);

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
            renderMenuCalendarEmpty(year, month);
        } finally {
            showMenuCalendarLoading(false);
        }
    }

    function showMenuCalendarLoading(show) {
        const grid = document.getElementById('menuCalendarGrid');
        if (show) {
            grid.innerHTML = '<div class="calendar-loading"><div class="loader-small"></div><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>';
        }
    }

    function renderMenuCalendar(days, year, month) {
        const grid = document.getElementById('menuCalendarGrid');
        grid.innerHTML = '';

        const firstDay = new Date(year, month - 1, 1);
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;

        // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
        for (let i = 1; i < startDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();

        for (let d = 1; d <= daysInMonth; d++) {
            const dayData = days.find(day => {
                const parts = day.date.split('.');
                return parseInt(parts[0]) === d;
            });

            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –¥–µ–Ω—å
            const isLocked = dayData && dayData.locked;

            if (isLocked) {
                dayEl.classList.add('locked');
            } else if (dayData && dayData.mood && dayData.mood !== 'locked') {
                dayEl.classList.add(dayData.mood);
            }

            if (year === today.getFullYear() &&
                month - 1 === today.getMonth() &&
                d === today.getDate()) {
                dayEl.classList.add('today');
            }

            const dayNum = document.createElement('span');
            dayNum.textContent = d;
            dayEl.appendChild(dayNum);

            // –¢–æ—á–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            if (!isLocked && dayData && dayData.mood && dayData.mood !== 'locked') {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dayEl.appendChild(dot);
            }

            // –ö–ª–∏–∫: —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
            if (isLocked) {
                dayEl.onclick = () => {
                    haptic('error');
                    showToast('–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –¥–Ω—é');
                };
            } else {
                dayEl.onclick = async () => {
                    currentDate = new Date(year, month - 1, d);
                    await loadForecast(currentDate);
                    haptic('medium');
                };
            }

            grid.appendChild(dayEl);
        }
    }

    function renderMenuCalendarEmpty(year, month) {
        const grid = document.getElementById('menuCalendarGrid');
        grid.innerHTML = '';

        const firstDay = new Date(year, month - 1, 1);
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;

        for (let i = 1; i < startDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();

        for (let d = 1; d <= daysInMonth; d++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day neutral';

            if (year === today.getFullYear() &&
                month - 1 === today.getMonth() &&
                d === today.getDate()) {
                dayEl.classList.add('today');
            }

            dayEl.textContent = d;

            dayEl.onclick = async () => {
                currentDate = new Date(year, month - 1, d);
                await loadForecast(currentDate);
                haptic('medium');
            };

            grid.appendChild(dayEl);
        }
    }

    async function loadSettings() {
        try {
            const headers = {};
            if (tg && tg.initData) {
                headers['X-Telegram-Init-Data'] = tg.initData;
            }
            const response = await fetch(`/api/user/${userId}/settings`, { headers });
            if (response.ok) {
                const settings = await response.json();
                document.getElementById('forecastTimeValue').textContent = settings.forecast_time || '09:00';
                document.getElementById('forecastToggle').checked = settings.forecast_enabled !== false;
                document.getElementById('notificationsToggle').checked = settings.push_enabled || false;

                // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.time === settings.forecast_time);
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
                if (settings.user_data) {
                    document.getElementById('menuBirthDate').textContent = settings.user_data.birth_date || '‚Äî';
                    document.getElementById('menuBirthTime').textContent = settings.user_data.birth_time || '‚Äî';
                    document.getElementById('menuBirthPlace').textContent = settings.user_data.birth_place || '‚Äî';
                    document.getElementById('menuResidence').textContent = settings.user_data.residence || '‚Äî';
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
        }
    }

    function getAuthHeaders() {
        const headers = { 'Content-Type': 'application/json' };
        if (tg && tg.initData) {
            headers['X-Telegram-Init-Data'] = tg.initData;
        }
        return headers;
    }

    async function saveForecastTime(time) {
        try {
            const response = await fetch(`/api/user/${userId}/settings`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ forecast_time: time })
            });
            if (response.ok) {
                showToast(`–í—Ä–µ–º—è –ø—Ä–æ–≥–Ω–æ–∑–∞: ${time}`);
            } else {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', true);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
        }
    }

    async function saveForecastEnabled(enabled) {
        try {
            const response = await fetch(`/api/user/${userId}/settings`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ forecast_enabled: enabled })
            });
            if (response.ok) {
                showToast(enabled ? '–£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –≤–∫–ª—é—á—ë–Ω' : '–£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –≤—ã–∫–ª—é—á–µ–Ω');
            } else {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', true);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
        }
    }

    async function saveNotificationsSetting(enabled) {
        try {
            const response = await fetch(`/api/user/${userId}/settings`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ push_enabled: enabled })
            });
            if (response.ok) {
                showToast(enabled ? '–í–∞–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã' : '–í–∞–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –≤—ã–∫–ª—é—á–µ–Ω—ã');
            } else {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', true);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
        }
    }

    // ============== –†–ï–ù–î–ï–†–ò–ù–ì ==============

    function renderForecast(data) {
        document.getElementById('dayName').textContent = data.day_name;
        document.getElementById('dateText').textContent = data.date;

        const moodCard = document.getElementById('moodCard');
        moodCard.className = 'mood-card ' + data.mood;
        document.getElementById('moodEmoji').textContent = moodEmoji[data.mood] || 'üòå';
        document.getElementById('moodTitle').textContent = moodTitle[data.mood] || '–î–µ–Ω—å';
        document.getElementById('moodSubtitle').textContent = moodSubtitle[data.mood] || '';

        const summaryText = data.summary || '–ü—Ä–æ–≥–Ω–æ–∑ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è...';
        document.getElementById('forecastText').textContent = summaryText;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        currentForecastSummary = summaryText;

        // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è
        clearQuestionHistory();

        renderTransits(data.transits || []);
    }

    function renderTransits(transits) {
        const container = document.getElementById('transitsList');
        container.innerHTML = '';

        if (!transits || transits.length === 0) {
            container.innerHTML = '<p class="empty-state">–ù–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>';
            return;
        }

        transits.forEach((tr, i) => {
            const h = parseInt(tr.time.split(':')[0]);
            const startH = Math.max(0, h - 2);
            const timeRange = `${String(startH).padStart(2, '0')}:00 ‚Äî ${tr.time}`;

            const tSym = planetSymbols[tr.transit_planet] || tr.transit_planet;
            const nSym = planetSymbols[tr.natal_planet] || tr.natal_planet;

            const item = document.createElement('div');
            item.className = `timeline-item ${tr.nature}`;
            item.style.animationDelay = `${i * 0.05}s`;

            item.innerHTML = `
                <div class="timeline-time">${sanitize(timeRange)}</div>
                <div class="timeline-planets">
                    <span class="planet-symbol">${sanitize(tSym)}</span>
                    <span class="aspect-symbol">${sanitize(tr.aspect_symbol)}</span>
                    <span class="planet-symbol">${sanitize(nSym)}</span>
                </div>
                <div class="timeline-meaning">${sanitize(tr.aspect)} ‚Äî ${sanitize(tr.formula)}</div>
                <div class="timeline-details">
                    ${tr.meanings.map(m => `<div class="detail-row"><span class="detail-value">‚Ä¢ ${sanitize(m)}</span></div>`).join('')}
                </div>
            `;

            item.onclick = () => {
                item.classList.toggle('expanded');
                haptic('light');
            };

            container.appendChild(item);
        });
    }

    function renderCalendar(days, year, month) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const firstDay = new Date(year, month - 1, 1);
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;

        for (let i = 1; i < startDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();

        for (let d = 1; d <= daysInMonth; d++) {
            const dayData = days.find(day => {
                const parts = day.date.split('.');
                return parseInt(parts[0]) === d;
            });

            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –¥–µ–Ω—å
            const isLocked = dayData && dayData.locked;

            if (isLocked) {
                dayEl.classList.add('locked');
            } else if (dayData && dayData.mood && dayData.mood !== 'locked') {
                dayEl.classList.add(dayData.mood);
            }

            if (year === today.getFullYear() &&
                month - 1 === today.getMonth() &&
                d === today.getDate()) {
                dayEl.classList.add('today');
            }

            // –ß–∏—Å–ª–æ –¥–Ω—è
            const dayNum = document.createElement('span');
            dayNum.textContent = d;
            dayEl.appendChild(dayNum);

            // –¢–æ—á–∫–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)
            if (!isLocked && dayData && dayData.mood && dayData.mood !== 'locked') {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dayEl.appendChild(dot);
            }

            // –ö–ª–∏–∫: —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
            if (isLocked) {
                dayEl.onclick = () => {
                    haptic('error');
                    showToast('–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –¥–Ω—é');
                };
            } else {
                dayEl.onclick = async () => {
                    currentDate = new Date(year, month - 1, d);
                    await loadForecast(currentDate);
                    haptic('medium');
                };
            }

            grid.appendChild(dayEl);
        }
    }

    function renderCalendarWithoutData(year, month) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const firstDay = new Date(year, month - 1, 1);
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;

        for (let i = 1; i < startDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();

        for (let d = 1; d <= daysInMonth; d++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day neutral';

            if (year === today.getFullYear() &&
                month - 1 === today.getMonth() &&
                d === today.getDate()) {
                dayEl.classList.add('today');
            }

            dayEl.textContent = d;

            dayEl.onclick = async () => {
                currentDate = new Date(year, month - 1, d);
                await loadForecast(currentDate);
                haptic('medium');
            };

            grid.appendChild(dayEl);
        }
    }

    // ============== –£–¢–ò–õ–ò–¢–´ ==============

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function showLoading(text) {
        document.getElementById('loadingText').textContent = text || '–ó–∞–≥—Ä—É–∑–∫–∞...';
        showScreen('loading');
    }

    // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è retry
    let lastAction = null;

    function showError(message, title = '–û—à–∏–±–∫–∞', canRetry = false) {
        // Haptic feedback –ø—Ä–∏ –æ—à–∏–±–∫–µ
        haptic('error');

        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorText').textContent = message;
        document.getElementById('retryBtn').style.display = canRetry ? 'block' : 'none';
        showScreen('error');
    }

    function retryLastAction() {
        if (lastAction && typeof lastAction === 'function') {
            haptic('medium');
            lastAction();
        } else {
            showScreen('menu');
        }
    }

    function formatDateForApi(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function haptic(style) {
        if (tg?.HapticFeedback) {
            // Notification types: error, success, warning
            if (['error', 'success', 'warning'].includes(style)) {
                tg.HapticFeedback.notificationOccurred(style);
            } else {
                // Impact types: light, medium, heavy, rigid, soft
                tg.HapticFeedback.impactOccurred(style);
            }
        }
    }

    // XSS –∑–∞—â–∏—Ç–∞ ‚Äî —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML
    function sanitize(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showToast(message, isError = false) {
        // Haptic feedback –ø—Ä–∏ –ø–æ–∫–∞–∑–µ toast
        haptic(isError ? 'error' : 'success');

        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast' + (isError ? ' error' : '');
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }
    </script>

    <!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="toast-container" id="toast-container"></div>
</body>
</html>
