#!/usr/bin/env python3
# coding: utf-8

"""
Формулы планет и правила управления знаками
Источник: "Предсказательная астрология" (1996)

Каждая планета имеет набор ключевых значений, которые проявляются
в зависимости от аспектов (гармоничных или напряжённых).
"""

# ============== ПРАВИЛА УПРАВЛЕНИЯ ЗНАКАМИ ==============
# По системе Шестопалова
# Основной управитель + дополнительный (только если эта планета ретроградная!)
# Соуправления в обычном режиме НЕТ!

SIGN_RULERS = {
    "Овен":     {"ruler": "Плутон",   "retro_ruler": "Марс"},     # + Марс если Марс ретро
    "Телец":    {"ruler": "Венера",   "retro_ruler": None},
    "Близнецы": {"ruler": "Меркурий", "retro_ruler": None},
    "Рак":      {"ruler": "Луна",     "retro_ruler": None},
    "Лев":      {"ruler": "Солнце",   "retro_ruler": None},
    "Дева":     {"ruler": "Меркурий", "retro_ruler": None},
    "Весы":     {"ruler": "Венера",   "retro_ruler": None},
    "Скорпион": {"ruler": "Марс",     "retro_ruler": "Плутон"},   # + Плутон если Плутон ретро
    "Стрелец":  {"ruler": "Юпитер",   "retro_ruler": "Нептун"},   # + Нептун если Нептун ретро
    "Козерог":  {"ruler": "Сатурн",   "retro_ruler": "Уран"},     # + Уран если Уран ретро
    "Водолей":  {"ruler": "Уран",     "retro_ruler": "Сатурн"},   # + Сатурн если Сатурн ретро
    "Рыбы":     {"ruler": "Нептун",   "retro_ruler": "Юпитер"},   # + Юпитер если Юпитер ретро
}

# Обратная таблица: какими знаками управляет каждая планета
# ТОЛЬКО основное управление (без ретро-вариантов)
PLANET_RULERSHIPS = {
    "Солнце":   {"rules": ["Лев"]},
    "Луна":     {"rules": ["Рак"]},
    "Меркурий": {"rules": ["Близнецы", "Дева"]},
    "Венера":   {"rules": ["Телец", "Весы"]},
    "Марс":     {"rules": ["Скорпион"]},        # Только Скорпион!
    "Юпитер":   {"rules": ["Стрелец"]},         # Только Стрелец!
    "Сатурн":   {"rules": ["Козерог"]},         # Только Козерог!
    "Уран":     {"rules": ["Водолей"]},         # Только Водолей!
    "Нептун":   {"rules": ["Рыбы"]},            # Только Рыбы!
    "Плутон":   {"rules": ["Овен"]},            # Только Овен!
}

# ============== РЕТРОГРАДНЫЕ УПРАВЛЕНИЯ ==============
# Когда планета ретроградная, она ДОБАВЛЯЕТ управление вторым знаком
# Это ПОЛНОЕ управление, не соуправление!

RETROGRADE_RULERSHIPS = {
    # Марс ретро: + Овен (к основному Скорпиону)
    "Марс":    {"extra_rules": ["Овен"]},
    # Плутон ретро: + Скорпион (к основному Овну)
    "Плутон":  {"extra_rules": ["Скорпион"]},
    # Юпитер ретро: + Рыбы (к основному Стрельцу)
    "Юпитер":  {"extra_rules": ["Рыбы"]},
    # Нептун ретро: + Стрелец (к основным Рыбам)
    "Нептун":  {"extra_rules": ["Стрелец"]},
    # Сатурн ретро: + Водолей (к основному Козерогу)
    "Сатурн":  {"extra_rules": ["Водолей"]},
    # Уран ретро: + Козерог (к основному Водолею)
    "Уран":    {"extra_rules": ["Козерог"]},
}

# Порядок знаков для определения номера дома
SIGNS_ORDER = [
    "Овен", "Телец", "Близнецы", "Рак", "Лев", "Дева",
    "Весы", "Скорпион", "Стрелец", "Козерог", "Водолей", "Рыбы"
]


# ============== РАСЧЁТ ФОРМУЛ ПО УПРАВЛЕНИЮ ==============

def get_cusp_sign(longitude: float) -> str:
    """
    Определить знак зодиака по долготе куспида

    Args:
        longitude: Долгота в градусах (0-360)

    Returns:
        Название знака
    """
    sign_index = int(longitude / 30) % 12
    return SIGNS_ORDER[sign_index]


def get_houses_ruled_by_planet(planet: str, cusp_signs: list) -> tuple:
    """
    Получить список домов, управляемых планетой (простая версия по куспидам)

    По системе Шестопалова соуправления нет!

    Args:
        planet: Название планеты (например, "Марс")
        cusp_signs: Список знаков на куспидах домов [знак_1дома, знак_2дома, ...]

    Returns:
        Кортеж (ruled_houses, [])
    """
    if planet not in PLANET_RULERSHIPS:
        return [], []

    rulership = PLANET_RULERSHIPS[planet]
    ruled_signs = set(rulership.get("rules", []))

    ruled_houses = []

    for house_num, sign in enumerate(cusp_signs, start=1):
        if sign in ruled_signs:
            ruled_houses.append(house_num)

    return sorted(ruled_houses), []


def format_houses_with_co_ruler(ruled: list, co_ruled: list) -> str:
    """
    Форматировать дома управления

    По системе Шестопалова соуправления нет!
    co_ruled всегда пустой, оставлен для совместимости.

    Args:
        ruled: Список домов управления
        co_ruled: Список домов (не используется)

    Returns:
        Строка вида "2 3 11"
    """
    return " ".join(str(h) for h in ruled)


def calculate_transit_formula(
    transit_planet: str,
    natal_planet: str,
    cusps: list,
    transit_house: int = 0,
    natal_house: int = 0,
    aspect_nature: str = "neutral",
    natal_is_retrograde: bool = False,
    transit_is_retrograde: bool = False
) -> str:
    """
    Рассчитать формулу транзитного аспекта в полном формате

    Формат: X (a b c d₀ e₀) +/- Y (f g h₀)
    Где:
    - X — дом позиции транзитной планеты
    - (a b c d₀ e₀) — дома управления транзитной планеты (₀ = соуправление)
    - +/- — знак аспекта (+ гармонич, - напряжён, ± нейтрал)
    - Y — дом позиции натальной планеты
    - (f g h₀) — дома управления натальной планеты

    Учитывает:
    - Позицию планеты (включается в список домов)
    - Ретроградность (расширенные управления)
    - Правила 13.5° и >50%

    Args:
        transit_planet: Транзитная планета
        natal_planet: Натальная планета
        cusps: Список долгот куспидов (12 штук) — НЕ знаки!
        transit_house: Дом где находится транзитная планета
        natal_house: Дом где находится натальная планета
        aspect_nature: Природа аспекта ("harmonious", "tense", "neutral")
        natal_is_retrograde: Ретроградна ли натальная планета
        transit_is_retrograde: Ретроградна ли транзитная планета

    Returns:
        Строка формулы или "" если не удалось вычислить
    """
    if not cusps or len(cusps) < 12:
        return ""

    # Получаем дома управления (полный расчёт с учётом всех правил)
    # Для транзитной планеты - учитываем транзитную ретроградность и позицию
    tr_ruled, tr_co_ruled = get_houses_ruled_by_planet_full(
        transit_planet, cusps,
        is_retrograde=transit_is_retrograde,
        planet_house=transit_house
    )

    # Для натальной планеты - учитываем натальную ретроградность и позицию
    nat_ruled, nat_co_ruled = get_houses_ruled_by_planet_full(
        natal_planet, cusps,
        is_retrograde=natal_is_retrograde,
        planet_house=natal_house
    )

    # Форматируем дома
    tr_houses_str = format_houses_with_co_ruler(tr_ruled, tr_co_ruled)
    nat_houses_str = format_houses_with_co_ruler(nat_ruled, nat_co_ruled)

    # Определяем знак аспекта
    if aspect_nature == "harmonious" or aspect_nature == "гармоничный":
        sign = "+"
    elif aspect_nature == "tense" or aspect_nature == "напряжённый":
        sign = "-"
    else:
        sign = "±"

    # Формируем формулу
    tr_part = f"{transit_house}"
    if tr_houses_str:
        tr_part += f"({tr_houses_str})"

    nat_part = f"{natal_house}"
    if nat_houses_str:
        nat_part += f"({nat_houses_str})"

    return f"{tr_part} {sign} {nat_part}"


def get_cusp_signs_from_houses(houses_cusps: list) -> list:
    """
    Преобразовать список долгот куспидов в список знаков

    Args:
        houses_cusps: Список долгот куспидов [долгота_1, долгота_2, ...]

    Returns:
        Список знаков ["Овен", "Телец", ...]
    """
    return [get_cusp_sign(cusp) for cusp in houses_cusps]


def get_house_size(cusp_start: float, cusp_end: float) -> float:
    """
    Вычислить размер дома в градусах

    Args:
        cusp_start: Долгота начала дома
        cusp_end: Долгота конца дома

    Returns:
        Размер дома в градусах
    """
    start = cusp_start % 360
    end = cusp_end % 360

    if end < start:
        return (360 - start) + end
    return end - start


def get_sign_degrees_in_house(sign_idx: int, cusp_start: float, cusp_end: float) -> float:
    """
    Вычислить сколько градусов знака содержится в доме

    Args:
        sign_idx: Индекс знака (0-11)
        cusp_start: Долгота начала дома
        cusp_end: Долгота конца дома

    Returns:
        Количество градусов знака в этом доме
    """
    sign_start = sign_idx * 30
    sign_end = sign_start + 30

    start = cusp_start % 360
    end = cusp_end % 360

    # Нормализуем для случая перехода через 0°
    if end < start:
        end += 360
    if sign_end <= start:
        sign_start += 360
        sign_end += 360

    # Находим пересечение
    overlap_start = max(start, sign_start)
    overlap_end = min(end, sign_end)

    if overlap_end <= overlap_start:
        return 0.0

    return overlap_end - overlap_start


def get_signs_in_house_detailed(cusp_start: float, cusp_end: float) -> list:
    """
    Получить все знаки в доме с количеством градусов каждого

    Args:
        cusp_start: Долгота начала дома (куспид)
        cusp_end: Долгота конца дома (куспид следующего дома)

    Returns:
        Список кортежей [(знак, градусы, процент_дома), ...]
    """
    result = []
    house_size = get_house_size(cusp_start, cusp_end)

    for i in range(12):
        degrees = get_sign_degrees_in_house(i, cusp_start, cusp_end)
        if degrees > 0:
            sign = SIGNS_ORDER[i]
            percent = (degrees / house_size * 100) if house_size > 0 else 0
            result.append((sign, degrees, percent))

    return result


def get_signs_in_house(cusp_start: float, cusp_end: float) -> list:
    """
    Получить все знаки, содержащиеся в доме

    Args:
        cusp_start: Долгота начала дома (куспид)
        cusp_end: Долгота конца дома (куспид следующего дома)

    Returns:
        Список знаков в этом доме
    """
    detailed = get_signs_in_house_detailed(cusp_start, cusp_end)
    return [sign for sign, _, _ in detailed]


def get_all_signs_in_houses(cusps: list) -> dict:
    """
    Получить все знаки для каждого дома

    Args:
        cusps: Список долгот куспидов (12 штук)

    Returns:
        Словарь {номер_дома: [список_знаков]}
    """
    house_signs = {}

    for i in range(12):
        house_num = i + 1
        cusp_start = cusps[i]
        cusp_end = cusps[(i + 1) % 12]

        house_signs[house_num] = get_signs_in_house(cusp_start, cusp_end)

    return house_signs


def get_all_signs_in_houses_detailed(cusps: list) -> dict:
    """
    Получить все знаки для каждого дома с деталями (градусы, проценты)

    Args:
        cusps: Список долгот куспидов (12 штук)

    Returns:
        Словарь {номер_дома: [(знак, градусы, процент), ...]}
    """
    house_signs = {}

    for i in range(12):
        house_num = i + 1
        cusp_start = cusps[i]
        cusp_end = cusps[(i + 1) % 12]

        house_signs[house_num] = get_signs_in_house_detailed(cusp_start, cusp_end)

    return house_signs


def get_houses_ruled_by_planet_full(
    planet: str,
    cusps: list,
    is_retrograde: bool = False,
    planet_house: int = 0
) -> tuple:
    """
    Получить список домов, управляемых планетой (полный расчёт)

    По системе Шестопалова:
    - Соуправления в обычном режиме НЕТ!
    - При ретроградности планета получает ПОЛНОЕ управление вторым знаком

    Учитывает:
    1. ВСЕ знаки в каждом доме, не только знак на куспиде
    2. Правило 13.5° — если знак занимает ≥13.5° в доме
    3. Правило >50% — если второй знак занимает более половины дома
    4. Ретроградность — планета получает дополнительный знак

    Args:
        planet: Название планеты
        cusps: Список долгот куспидов (12 штук)
        is_retrograde: Является ли планета ретроградной
        planet_house: Дом где находится планета (не используется в формуле)

    Returns:
        Кортеж (ruled_houses, []) — соуправления больше нет!
    """
    if planet not in PLANET_RULERSHIPS:
        return [], []

    # Базовые управления планеты (только основные знаки)
    rulership = PLANET_RULERSHIPS[planet]
    ruled_signs = set(rulership.get("rules", []))

    # При ретроградности добавляем второй знак (полное управление!)
    if is_retrograde and planet in RETROGRADE_RULERSHIPS:
        retro_data = RETROGRADE_RULERSHIPS[planet]
        for sign in retro_data.get("extra_rules", []):
            ruled_signs.add(sign)

    # Получаем все знаки для каждого дома с деталями
    house_signs = get_all_signs_in_houses_detailed(cusps)

    ruled_houses = set()

    for house_num, signs_data in house_signs.items():
        for idx, (sign, degrees, percent) in enumerate(signs_data):
            # Проверяем управление
            is_ruled = sign in ruled_signs

            if idx == 0:
                # Первый знак (на куспиде) — полное управление
                if is_ruled:
                    ruled_houses.add(house_num)
            else:
                # Второй и далее знаки — проверяем правила:
                # Правило 13.5°: если знак занимает ≥13.5°
                # Правило >50%: если знак занимает более половины дома
                if is_ruled and (degrees >= 13.5 or percent > 50):
                    ruled_houses.add(house_num)

    # Возвращаем только ruled_houses, соуправления нет!
    return sorted(ruled_houses), []


# ============== ЗНАЧЕНИЯ ПЛАНЕТ ==============

PLANET_MEANINGS = {
    "Солнце": {
        "symbol": "☉",
        "keywords": ["воля", "эго", "жизненная сила", "творчество", "самовыражение"],
        "positive": [
            "творческий подъём",
            "укрепление здоровья",
            "признание заслуг",
            "повышение самооценки",
            "ясность целей"
        ],
        "negative": [
            "эгоизм",
            "конфликты с авторитетами",
            "проблемы со здоровьем",
            "потеря энергии",
            "кризис самоидентификации"
        ],
        "body_parts": ["сердце", "позвоночник", "глаза"],
        "sphere": "личность, творчество, власть"
    },

    "Луна": {
        "symbol": "☽",
        "keywords": ["эмоции", "подсознание", "дом", "семья", "привычки"],
        "positive": [
            "эмоциональная гармония",
            "улучшение отношений с близкими",
            "интуитивные прозрения",
            "комфорт в быту",
            "забота и поддержка"
        ],
        "negative": [
            "эмоциональная нестабильность",
            "семейные конфликты",
            "проблемы с жильём",
            "капризность",
            "зависимость от других"
        ],
        "body_parts": ["желудок", "грудь", "лимфа"],
        "sphere": "эмоции, быт, семья"
    },

    "Меркурий": {
        "symbol": "☿",
        "keywords": ["мышление", "коммуникации", "обучение", "поездки", "документы"],
        "positive": [
            "успешные переговоры",
            "новые знания",
            "удачные поездки",
            "ясность мышления",
            "подписание договоров"
        ],
        "negative": [
            "недоразумения в общении",
            "проблемы с документами",
            "задержки в поездках",
            "рассеянность",
            "сплетни и слухи"
        ],
        "body_parts": ["нервная система", "руки", "лёгкие"],
        "sphere": "коммуникации, обучение, торговля"
    },

    "Венера": {
        "symbol": "♀",
        "keywords": ["любовь", "красота", "деньги", "гармония", "искусство"],
        "positive": [
            "романтические встречи",
            "финансовые поступления",
            "творческое вдохновение",
            "гармония в отношениях",
            "эстетические удовольствия"
        ],
        "negative": [
            "разочарования в любви",
            "финансовые потери",
            "лень и праздность",
            "конфликты в отношениях",
            "излишества"
        ],
        "body_parts": ["почки", "горло", "вены"],
        "sphere": "любовь, финансы, искусство"
    },

    "Марс": {
        "symbol": "♂",
        "keywords": ["энергия", "действие", "борьба", "сексуальность", "инициатива"],
        "positive": [
            "энергия для действий",
            "победа в конкуренции",
            "физическая активность",
            "смелые решения",
            "сексуальная энергия"
        ],
        "negative": [
            "конфликты и ссоры",
            "травмы и порезы",
            "агрессия",
            "поспешные решения",
            "переутомление"
        ],
        "body_parts": ["мышцы", "кровь", "голова"],
        "sphere": "действие, спорт, конкуренция"
    },

    "Юпитер": {
        "symbol": "♃",
        "keywords": ["расширение", "удача", "образование", "путешествия", "мировоззрение"],
        "positive": [
            "удача и везение",
            "расширение возможностей",
            "дальние путешествия",
            "повышение статуса",
            "духовный рост"
        ],
        "negative": [
            "чрезмерный оптимизм",
            "переоценка сил",
            "расточительность",
            "проблемы с законом",
            "религиозный фанатизм"
        ],
        "body_parts": ["печень", "бёдра", "артерии"],
        "sphere": "удача, образование, путешествия"
    },

    "Сатурн": {
        "symbol": "♄",
        "keywords": ["ограничения", "структура", "ответственность", "время", "карьера"],
        "positive": [
            "достижение целей",
            "карьерный рост",
            "признание опыта",
            "стабильность",
            "дисциплина"
        ],
        "negative": [
            "задержки и препятствия",
            "чувство одиночества",
            "проблемы с костями",
            "депрессия",
            "излишняя строгость"
        ],
        "body_parts": ["кости", "кожа", "зубы", "колени"],
        "sphere": "карьера, ответственность, структура"
    },

    "Уран": {
        "symbol": "♅",
        "keywords": ["неожиданности", "свобода", "технологии", "революция", "оригинальность"],
        "positive": [
            "внезапные возможности",
            "освобождение от рутины",
            "технические прорывы",
            "оригинальные идеи",
            "новые знакомства"
        ],
        "negative": [
            "внезапные потрясения",
            "нестабильность",
            "разрывы отношений",
            "аварии с техникой",
            "эксцентричность"
        ],
        "body_parts": ["нервная система", "лодыжки"],
        "sphere": "перемены, технологии, свобода"
    },

    "Нептун": {
        "symbol": "♆",
        "keywords": ["иллюзии", "духовность", "интуиция", "творчество", "зависимости"],
        "positive": [
            "творческое вдохновение",
            "духовные прозрения",
            "романтика",
            "интуитивное понимание",
            "сострадание"
        ],
        "negative": [
            "обман и иллюзии",
            "путаница",
            "зависимости",
            "потеря границ",
            "разочарования"
        ],
        "body_parts": ["стопы", "лимфа", "психика"],
        "sphere": "духовность, творчество, иллюзии"
    },

    "Плутон": {
        "symbol": "♇",
        "keywords": ["трансформация", "власть", "смерть/возрождение", "сексуальность", "кризисы"],
        "positive": [
            "глубокая трансформация",
            "обретение силы",
            "избавление от старого",
            "психологические прорывы",
            "власть и влияние"
        ],
        "negative": [
            "кризисы и потрясения",
            "потеря контроля",
            "манипуляции",
            "разрушение",
            "навязчивые состояния"
        ],
        "body_parts": ["репродуктивная система", "прямая кишка"],
        "sphere": "трансформация, власть, кризисы"
    }
}


# ============== ЗНАЧЕНИЯ АСПЕКТОВ ==============

ASPECT_MEANINGS = {
    "Соединение": {
        "symbol": "☌",
        "nature": "нейтральный",
        "orb": 8,
        "description": "Слияние энергий планет. Может быть как гармоничным, так и напряжённым в зависимости от планет.",
        "keywords": ["объединение", "усиление", "начало цикла"]
    },

    "Секстиль": {
        "symbol": "⚹",
        "nature": "гармоничный",
        "orb": 6,
        "description": "Благоприятные возможности, которые требуют небольших усилий для реализации.",
        "keywords": ["возможности", "сотрудничество", "лёгкость"]
    },

    "Квадратура": {
        "symbol": "□",
        "nature": "напряжённый",
        "orb": 8,
        "description": "Внутреннее напряжение, требующее действий. Источник энергии для преодоления препятствий.",
        "keywords": ["напряжение", "препятствия", "действие", "вызов"]
    },

    "Тригон": {
        "symbol": "△",
        "nature": "гармоничный",
        "orb": 8,
        "description": "Естественная гармония и везение. Таланты и возможности даются легко.",
        "keywords": ["гармония", "везение", "таланты", "поток"]
    },

    "Оппозиция": {
        "symbol": "☍",
        "nature": "напряжённый",
        "orb": 8,
        "description": "Противостояние, требующее баланса. Часто проявляется через других людей.",
        "keywords": ["противостояние", "баланс", "осознание", "отношения"]
    }
}


# ============== ФОРМУЛЫ СОБЫТИЙ (по Шестопалову) ==============
# Источник: "Таблица формул событий" С.В. Шестопалов
# Обозначения:
#   "7+-4" = 7 дом в любой связи (гармоничной или напряжённой) с 4 домом
#   "7+4" = 7 дом в гармоничной связи с 4 домом
#   "7-4" = 7 дом в напряжённой связи с 4 домом

EVENT_FORMULAS = {
    # ============== ОТНОШЕНИЯ, БРАК ==============
    "счастье_в_личной_жизни": {
        "formula": "7+Венера или 7+Юпитер или 7+Солнце",
        "houses": [7],
        "planets": ["Венера", "Юпитер", "Солнце"],
        "aspect_type": "гармоничный",
        "description": "Венера даёт симпатичного партнёра, Юпитер увеличивает возможности, Солнце — активного яркого партнёра в 7 доме",
        "category": "отношения"
    },

    "несчастье_в_личной_жизни": {
        "formula": "7-Сатурн или 7-Марс",
        "houses": [7],
        "planets": ["Сатурн", "Марс"],
        "aspect_type": "напряжённый",
        "description": "Сатурн и Марс в напряжённых аспектах к 7 дому создают трудности в личной жизни",
        "category": "отношения"
    },

    "богатый_супруг": {
        "formula": "7+-8",
        "houses": [7, 8],
        "planets": [],
        "aspect_type": "любой",
        "description": "7 дом и 8 дом (2 дом супруга от 7) имеют между собой много связей",
        "category": "отношения"
    },

    "разочарование_в_любви": {
        "formula": "7-12 или 7-Нептун",
        "houses": [7, 12],
        "planets": ["Нептун"],
        "aspect_type": "напряжённый",
        "description": "7 дом в напряженной связи с 12 домом или Нептуном приносит разочарования",
        "category": "отношения"
    },

    "формула_любви": {
        "formula": "7+-4",
        "houses": [7, 4],
        "planets": [],
        "aspect_type": "любой",
        "description": "В прогрессии также: 5+10 и 7+10. Связь домов любви и семьи",
        "category": "отношения"
    },

    "огорчение_в_любви": {
        "formula": "7-5",
        "houses": [7, 5],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "7 дом в напряженной связи с 5 домом. В прогрессии: 5-10 и 7-10",
        "category": "отношения"
    },

    "формула_развода": {
        "formula": "7-11 или 7-Уран",
        "houses": [7, 11],
        "planets": ["Уран"],
        "aspect_type": "напряжённый",
        "description": "7 дом в напряженных связях с Ураном или 11 домом — предрасположенность к разводу",
        "category": "отношения"
    },

    "фиктивный_брак_обман": {
        "formula": "7-12 или 7-Нептун",
        "houses": [7, 12],
        "planets": ["Нептун"],
        "aspect_type": "напряжённый",
        "description": "Связь 7 дома с 12 или Нептуном указывает на обман и иллюзии в браке",
        "category": "отношения"
    },

    "задержка_в_браке": {
        "formula": "7-Сатурн",
        "houses": [7],
        "planets": ["Сатурн"],
        "aspect_type": "напряжённый",
        "description": "Сатурн поражает элементы 7 дома — блокирующее влияние на брак",
        "category": "отношения"
    },

    "приемные_дети": {
        "formula": "5+12 или 5+Нептун",
        "houses": [5, 12],
        "planets": ["Нептун"],
        "aspect_type": "гармоничный",
        "description": "5 дом с 12 или Нептуном с добрыми связями благоприятен для приёмных детей",
        "category": "отношения"
    },

    "иностранный_супруг": {
        "formula": "7+-9 или 7+-12",
        "houses": [7, 9, 12],
        "planets": [],
        "aspect_type": "любой",
        "description": "Связь 7 дома с 9 или 12 — муж/жена иностранцы",
        "category": "отношения"
    },

    # ============== БОЛЕЗНИ, ЗДОРОВЬЕ ==============
    "формула_болезни": {
        "formula": "6-8 или 6-12 или 8-12",
        "houses": [6, 8, 12],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Дом 6, 8 или 12 в напряженных связях друг с другом. 3 связи не обязательно",
        "category": "здоровье"
    },

    "формула_бесплодия": {
        "formula": "Луна-Сатурн",
        "houses": [4, 5],
        "planets": ["Луна", "Сатурн"],
        "aspect_type": "напряжённый",
        "description": "Луна в знаке падения (Козерог, Лев для Венеры, Близнецы, Скорпион если Луна поражена Сатурном). Луна поражённая и без добрых аспектов. Физическое: Луна или элементы 4 дома поражены формулой болезни",
        "category": "здоровье"
    },

    "поздние_дети": {
        "formula": "5-Сатурн",
        "houses": [5],
        "planets": ["Сатурн"],
        "aspect_type": "напряжённый",
        "description": "Сатурн поражает элементы 5 дома — указание на поздних детей",
        "category": "здоровье"
    },

    "формула_зачатия": {
        "formula": "4+-5 или Луна+-5 или Луна+-Солнце",
        "houses": [4, 5],
        "planets": ["Луна", "Солнце"],
        "aspect_type": "любой",
        "description": "4 дом или Луна в связи с 5 домом или Солнцем",
        "category": "здоровье"
    },

    # ============== КАРЬЕРА, БИЗНЕС, РАБОТА ==============
    "карьера_марс": {
        "formula": "10+Марс",
        "houses": [10],
        "planets": ["Марс"],
        "aspect_type": "гармоничный",
        "description": "Марс в 10 доме способствует карьере",
        "category": "карьера"
    },

    "карьера_сатурн": {
        "formula": "10+-Сатурн",
        "houses": [10],
        "planets": ["Сатурн"],
        "aspect_type": "любой",
        "description": "Сатурн в 10 доме способствует карьере, но говорит о возможности высоко подняться и потом упасть",
        "category": "карьера"
    },

    "богатые_возможности": {
        "formula": "Юпитер+Плутон",
        "houses": [],
        "planets": ["Юпитер", "Плутон"],
        "aspect_type": "гармоничный",
        "description": "Аспект богатых возможностей — Юпитер в гармонии с Плутоном",
        "category": "карьера"
    },

    "хорошая_карьера_директор": {
        "formula": "10+-2 и 10+-6",
        "houses": [10, 2, 6],
        "planets": [],
        "aspect_type": "любой",
        "description": "В прогрессиях 10+-10. Для работы 6 дом не злой! Если есть 8 — материальная ответственность. Если есть 11 и много связей — человека продвигают",
        "category": "карьера"
    },

    "творческий_успех_признание": {
        "formula": "10+-9",
        "houses": [10, 9],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула творческого успеха и признания",
        "category": "карьера"
    },

    "генеральный_директор": {
        "formula": "6+-10",
        "houses": [6, 10],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула генерального директора, руководителя",
        "category": "карьера"
    },

    "хорошая_должность": {
        "formula": "2+-10",
        "houses": [2, 10],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула хорошей должности, карьеры",
        "category": "карьера"
    },

    "рекламщик": {
        "formula": "5+-9",
        "houses": [5, 9],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула рекламщика, работы в рекламе",
        "category": "карьера"
    },

    "формула_безработного": {
        "formula": "2-11",
        "houses": [2, 11],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Напряжённая связь 2 и 11 домов — риск безработицы",
        "category": "карьера"
    },

    "финансовый_выигрыш": {
        "formula": "5+-2+-8+-11",
        "houses": [5, 2, 8, 11],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула финансового выигрыша, финансиста. Казино: 5+-8 — выигрыш чужих денег. 2+-8 — работа с чужими деньгами",
        "category": "карьера"
    },

    "формула_бомжа": {
        "formula": "4-12",
        "houses": [4, 12],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Напряжённая связь 4 и 12 домов — потеря жилья",
        "category": "карьера"
    },

    "формула_могущества": {
        "formula": "2+-9 и 2+-11 и 11+-9",
        "houses": [2, 9, 11],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула богатых возможностей и могущества, крупного бизнеса",
        "category": "карьера"
    },

    "предприниматель_средний_бизнес": {
        "formula": "2+-8",
        "houses": [2, 8],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула предпринимателя, среднего бизнеса",
        "category": "карьера"
    },

    "потеря_работы": {
        "formula": "6-11 или 10-11 или 6-Уран или 10-Уран",
        "houses": [6, 10, 11],
        "planets": ["Уран"],
        "aspect_type": "напряжённый",
        "description": "Дома работы 6 или 10 в напряжённой связи с 11 или Ураном",
        "category": "карьера"
    },

    "признание_успеха": {
        "formula": "9+-10",
        "houses": [9, 10],
        "planets": [],
        "aspect_type": "любой",
        "description": "В быстрой прогрессии могут быть и добрые и отрицательные связи",
        "category": "карьера"
    },

    "проблемы_на_работе": {
        "formula": "2-10 или 2-6",
        "houses": [2, 10, 6],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Напряжённые связи 2 дома с 10 или 6 — проблемы на работе",
        "category": "карьера"
    },

    "суды_неблагоприятно": {
        "formula": "9-12",
        "houses": [9, 12],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Напряжённая связь 9 и 12 домов — не стоит подавать в суд",
        "category": "карьера"
    },

    "суды_благоприятно": {
        "formula": "9+12",
        "houses": [9, 12],
        "planets": [],
        "aspect_type": "гармоничный",
        "description": "Гармоничная связь 9 и 12 домов — подать в суд можно",
        "category": "карьера"
    },

    "формула_обмана_мошенничества": {
        "formula": "9-12",
        "houses": [9, 12],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "Напряжённая связь 9 и 12 домов — риск обмана, мошенничества",
        "category": "карьера"
    },

    # ============== НЕДВИЖИМОСТЬ ==============
    "хорошие_возможности_недвижимости": {
        "formula": "4+-8",
        "houses": [4, 8],
        "planets": [],
        "aspect_type": "любой",
        "description": "Хорошие возможности для квартиры, дачи, гаража, земли",
        "category": "недвижимость"
    },

    "дарение_квартиры": {
        "formula": "4+-5 и 11",
        "houses": [4, 5, 11],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула дарения квартиры, подарка недвижимости",
        "category": "недвижимость"
    },

    "служебное_жилье": {
        "formula": "4+-6",
        "houses": [4, 6],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула получения служебного жилья",
        "category": "недвижимость"
    },

    "наследство": {
        "formula": "4+-8 или 4+-11",
        "houses": [4, 8, 11],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула наследства недвижимости",
        "category": "недвижимость"
    },

    "выигрыш_квартиры": {
        "formula": "4+-8 и 5 и 6",
        "houses": [4, 8, 5, 6],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула выигрыша квартиры",
        "category": "недвижимость"
    },

    "пожар_в_доме": {
        "formula": "4-8 и 8-9",
        "houses": [4, 8, 9],
        "planets": [],
        "aspect_type": "напряжённый",
        "description": "4-8 — разрушение дома, 8-9 — формула взрывов и пожаров",
        "category": "недвижимость"
    },

    # ============== ПОЕЗДКИ, ЭМИГРАЦИЯ ==============
    "близкие_переезды": {
        "formula": "4+-3",
        "houses": [4, 3],
        "planets": [],
        "aspect_type": "любой",
        "description": "Переезд недалеко. Если есть 9 или 12 — значит далеко и не в одной стране/культуре, эмиграция",
        "category": "поездки"
    },

    "дальние_переезды": {
        "formula": "4+-9 или 4+-12",
        "houses": [4, 9, 12],
        "planets": [],
        "aspect_type": "любой",
        "description": "Формула дальних переездов, смены страны",
        "category": "поездки"
    },

    "эмиграция_через_работу": {
        "formula": "10+-9 или 10+-12 или 6+-9 или 6+-12",
        "houses": [10, 6, 9, 12],
        "planets": [],
        "aspect_type": "любой",
        "description": "Эмиграция в результате работы",
        "category": "поездки"
    },

    # ============== ЖИТЕЙСКИЕ ==============
    "талант_автомобилиста": {
        "formula": "3+-2 или Меркурий+-2",
        "houses": [3, 2],
        "planets": ["Меркурий"],
        "aspect_type": "любой",
        "description": "3 дом или Меркурий в связи с 2 домом — талант автомобилиста",
        "category": "житейские"
    },

    "покупка_авто": {
        "formula": "2+-3 или 8+-3 или 2+-Меркурий или 8+-Меркурий",
        "houses": [2, 8, 3],
        "planets": ["Меркурий"],
        "aspect_type": "любой",
        "description": "Формула покупки автомобиля (в прогрессии)",
        "category": "житейские"
    }
}


# ============== ИНТЕРПРЕТАЦИИ ТРАНЗИТОВ ==============

def get_transit_interpretation(
    transit_planet: str,
    natal_planet: str,
    aspect: str
) -> dict:
    """
    Получить интерпретацию транзита

    Args:
        transit_planet: Транзитная планета (например, "Юпитер")
        natal_planet: Натальная планета (например, "Венера")
        aspect: Аспект (например, "Тригон")

    Returns:
        Словарь с интерпретацией
    """
    t_data = PLANET_MEANINGS.get(transit_planet, {})
    n_data = PLANET_MEANINGS.get(natal_planet, {})
    a_data = ASPECT_MEANINGS.get(aspect, {})

    is_harmonious = a_data.get("nature") == "гармоничный"

    # Выбираем позитивные или негативные значения
    t_effects = t_data.get("positive" if is_harmonious else "negative", [])
    n_effects = n_data.get("positive" if is_harmonious else "negative", [])

    return {
        "transit": transit_planet,
        "natal": natal_planet,
        "aspect": aspect,
        "nature": a_data.get("nature", "нейтральный"),
        "transit_sphere": t_data.get("sphere", ""),
        "natal_sphere": n_data.get("sphere", ""),
        "keywords": t_data.get("keywords", []) + n_data.get("keywords", []),
        "possible_effects": t_effects[:2] + n_effects[:2],
        "body_parts": t_data.get("body_parts", []) + n_data.get("body_parts", []),
        "advice": _get_advice(transit_planet, natal_planet, aspect, is_harmonious)
    }


def _get_advice(transit: str, natal: str, aspect: str, harmonious: bool) -> str:
    """Сгенерировать совет по транзиту"""
    if harmonious:
        advices = {
            ("Юпитер", "Венера"): "Отличное время для финансовых решений и отношений",
            ("Юпитер", "Солнце"): "Используйте этот период для важных начинаний",
            ("Венера", "Луна"): "Уделите время семье и близким",
            ("Меркурий", "Юпитер"): "Хорошо для обучения и важных переговоров",
        }
        return advices.get((transit, natal), "Используйте благоприятные энергии этого периода")
    else:
        advices = {
            ("Сатурн", "Солнце"): "Время для серьёзной работы, избегайте переутомления",
            ("Марс", "Луна"): "Контролируйте эмоции, избегайте конфликтов",
            ("Уран", "Венера"): "Будьте готовы к неожиданностям в отношениях",
            ("Плутон", "Солнце"): "Период глубокой трансформации, доверьтесь процессу",
        }
        return advices.get((transit, natal), "Будьте внимательны и осторожны в этот период")


# ============== ПРИОРИТЕТ ТРАНЗИТОВ ==============

TRANSIT_PRIORITY = {
    # Медленные планеты = долгосрочные влияния
    "Плутон": {"weight": 10, "duration": "годы"},
    "Нептун": {"weight": 9, "duration": "годы"},
    "Уран": {"weight": 8, "duration": "месяцы-годы"},
    "Сатурн": {"weight": 7, "duration": "месяцы"},
    "Юпитер": {"weight": 6, "duration": "недели-месяцы"},

    # Быстрые планеты = краткосрочные влияния
    "Марс": {"weight": 4, "duration": "дни"},
    "Солнце": {"weight": 3, "duration": "дни"},
    "Венера": {"weight": 3, "duration": "дни"},
    "Меркурий": {"weight": 2, "duration": "дни"},
    "Луна": {"weight": 1, "duration": "часы"},
}


def get_transit_priority(transit_planet: str, orb: float) -> float:
    """
    Рассчитать приоритет транзита

    Args:
        transit_planet: Название транзитной планеты
        orb: Орбис в градусах

    Returns:
        Числовой приоритет (выше = важнее)
    """
    base = TRANSIT_PRIORITY.get(transit_planet, {}).get("weight", 1)
    # Чем меньше орбис, тем сильнее влияние
    orb_factor = max(0.1, 1 - orb / 10)
    return base * orb_factor


# ============== АНАЛИЗ ФОРМУЛ СОБЫТИЙ ==============

def check_active_formulas(
    transits: list,
    natal_houses: dict
) -> list:
    """
    Проверить какие формулы событий активны на основе транзитов

    Args:
        transits: Список активных транзитов с аспектами
                  Формат: [{"transit_planet": "Юпитер", "natal_planet": "Венера",
                           "aspect": "Тригон", "natal_house": 7, "transit_house": 2}]
        natal_houses: Словарь с планетами в домах натальной карты
                     Формат: {"Солнце": 5, "Луна": 7, ...}

    Returns:
        Список активных формул с уровнем активации
    """
    active_formulas = []

    for formula_key, formula_data in EVENT_FORMULAS.items():
        activation_score = 0
        matching_transits = []

        required_houses = formula_data.get("houses", [])
        required_planets = formula_data.get("planets", [])
        aspect_type = formula_data.get("aspect_type", "любой")

        for transit in transits:
            natal_planet = transit.get("natal_planet", "")
            transit_planet = transit.get("transit_planet", "")
            aspect = transit.get("aspect", "")
            natal_house = transit.get("natal_house", 0)
            transit_house = transit.get("transit_house", 0)

            # Определяем тип аспекта
            is_harmonious = aspect in ["Тригон", "Секстиль"]
            is_tense = aspect in ["Квадратура", "Оппозиция"]

            # Проверяем соответствие типу аспекта формулы
            if aspect_type == "гармоничный" and not is_harmonious:
                continue
            elif aspect_type == "напряжённый" and not is_tense:
                continue

            # Проверяем совпадение домов
            house_match = False
            if natal_house in required_houses or transit_house in required_houses:
                house_match = True

            # Проверяем совпадение планет
            planet_match = False
            if natal_planet in required_planets or transit_planet in required_planets:
                planet_match = True

            # Если нет требований к планетам, проверяем только дома
            if not required_planets:
                planet_match = True

            # Если нет требований к домам, проверяем только планеты
            if not required_houses:
                house_match = True

            if house_match and planet_match:
                activation_score += 1
                matching_transits.append(transit)

        # Если есть хотя бы одно совпадение, добавляем формулу
        if activation_score > 0:
            active_formulas.append({
                "key": formula_key,
                "formula": formula_data.get("formula", ""),
                "description": formula_data.get("description", ""),
                "category": formula_data.get("category", ""),
                "activation_score": activation_score,
                "matching_transits": matching_transits
            })

    # Сортируем по уровню активации (от большего к меньшему)
    active_formulas.sort(key=lambda x: x["activation_score"], reverse=True)

    return active_formulas


def get_formulas_by_category(category: str) -> dict:
    """
    Получить все формулы по категории

    Args:
        category: Категория (отношения, здоровье, карьера, недвижимость, поездки, житейские)

    Returns:
        Словарь формул данной категории
    """
    return {
        key: data for key, data in EVENT_FORMULAS.items()
        if data.get("category") == category
    }


def format_formula_for_ai(active_formulas: list) -> str:
    """
    Форматировать активные формулы для передачи в AI

    Args:
        active_formulas: Список активных формул из check_active_formulas()

    Returns:
        Текст для AI с описанием активных формул
    """
    if not active_formulas:
        return ""

    lines = ["АКТИВНЫЕ ФОРМУЛЫ СОБЫТИЙ:"]

    # Группируем по категориям
    categories = {}
    for formula in active_formulas:
        cat = formula.get("category", "другое")
        if cat not in categories:
            categories[cat] = []
        categories[cat].append(formula)

    category_names = {
        "отношения": "💑 ОТНОШЕНИЯ",
        "здоровье": "🏥 ЗДОРОВЬЕ",
        "карьера": "💼 КАРЬЕРА И ФИНАНСЫ",
        "недвижимость": "🏠 НЕДВИЖИМОСТЬ",
        "поездки": "✈️ ПОЕЗДКИ И ЭМИГРАЦИЯ",
        "житейские": "🚗 ЖИТЕЙСКИЕ"
    }

    for cat, formulas in categories.items():
        cat_name = category_names.get(cat, cat.upper())
        lines.append(f"\n{cat_name}:")

        for f in formulas[:3]:  # Максимум 3 формулы на категорию
            key = f["key"].replace("_", " ").title()
            desc = f["description"]
            score = f["activation_score"]
            lines.append(f"  • {key} (сила: {score}): {desc}")

    return "\n".join(lines)
