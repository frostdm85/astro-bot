#!/usr/bin/env python3
# coding: utf-8

"""
================================================================================
СПРАВОЧНИК РАСЧЁТА ФОРМУЛ СОБЫТИЙ ПО СИСТЕМЕ ШЕСТОПАЛОВА
================================================================================

Автор методики: С.В. Шестопалов
Реализация: astro-bot

Этот файл содержит ВСЮ методологию расчёта формул событий.
Используется как справочник для понимания алгоритмов.

================================================================================
СОДЕРЖАНИЕ:
================================================================================
1. ТАБЛИЦА УПРАВИТЕЛЕЙ ЗНАКОВ
2. ПРАВИЛА УПРАВЛЕНИЯ ДОМАМИ (4 правила + ретро)
3. МАТРИЦА ОРБИСОВ
4. ЗЛЫЕ И ДОБРЫЕ ПЛАНЕТЫ
5. АСПЕКТЫ И ИХ ПРИРОДА
6. СХОДЯЩИЙСЯ / РАСХОДЯЩИЙСЯ АСПЕКТ
7. АСПЕКТЫ К КУСПИДАМ ДОМОВ
8. ФОРМУЛА СОБЫТИЯ (структура вывода)
9. ПРАВИЛО ТРЁХ УКАЗАНИЙ
10. ПРИМЕР ПОЛНОГО РАСЧЁТА

================================================================================
"""

import swisseph as swe


# ==============================================================================
# 1. ТАБЛИЦА УПРАВИТЕЛЕЙ ЗНАКОВ
# ==============================================================================

"""
УПРАВИТЕЛИ ЗНАКОВ (система Шестопалова):

┌─────────────┬────────────┬─────────────────────────────────┐
│ Знак        │ Управитель │ Соуправитель (если планета R)   │
├─────────────┼────────────┼─────────────────────────────────┤
│ Овен        │ Плутон     │ + Марс (если Марс R)            │
│ Телец       │ Венера     │ -                               │
│ Близнецы    │ Меркурий   │ -                               │
│ Рак         │ Луна       │ -                               │
│ Лев         │ Солнце     │ -                               │
│ Дева        │ Меркурий   │ -                               │
│ Весы        │ Венера     │ -                               │
│ Скорпион    │ Марс       │ + Плутон (если Плутон R)        │
│ Стрелец     │ Юпитер     │ + Нептун (если Нептун R)        │
│ Козерог     │ Сатурн     │ + Уран (если Уран R)            │
│ Водолей     │ Уран       │ + Сатурн (если Сатурн R)        │
│ Рыбы        │ Нептун     │ + Юпитер (если Юпитер R)        │
└─────────────┴────────────┴─────────────────────────────────┘

ВАЖНО: Ретроградная планета управляет ДВУМЯ знаками!
       Например: Юпитер R → управляет Стрельцом + Рыбами
"""

# Основные управители (для ПРЯМЫХ планет)
SIGN_RULERS = {
    'Овен': 'Плутон',
    'Телец': 'Венера',
    'Близнецы': 'Меркурий',
    'Рак': 'Луна',
    'Лев': 'Солнце',
    'Дева': 'Меркурий',
    'Весы': 'Венера',
    'Скорпион': 'Марс',
    'Стрелец': 'Юпитер',
    'Козерог': 'Сатурн',
    'Водолей': 'Уран',
    'Рыбы': 'Нептун',
}

# Соуправители для РЕТРОГРАДНЫХ планет
SIGN_RULERS_RETRO = {
    'Овен': 'Марс',        # Марс R соуправляет Овном
    'Скорпион': 'Плутон',  # Плутон R соуправляет Скорпионом
    'Стрелец': 'Нептун',   # Нептун R соуправляет Стрельцом
    'Козерог': 'Уран',     # Уран R соуправляет Козерогом
    'Водолей': 'Сатурн',   # Сатурн R соуправляет Водолеем
    'Рыбы': 'Юпитер',      # Юпитер R соуправляет Рыбами
}

# Какими знаками управляет каждая планета (прямая)
PLANET_SIGNS = {
    'Солнце': ['Лев'],
    'Луна': ['Рак'],
    'Меркурий': ['Близнецы', 'Дева'],
    'Венера': ['Телец', 'Весы'],
    'Марс': ['Скорпион'],
    'Юпитер': ['Стрелец'],
    'Сатурн': ['Козерог'],
    'Уран': ['Водолей'],
    'Нептун': ['Рыбы'],
    'Плутон': ['Овен'],
}

# Дополнительные знаки для ретроградных планет
PLANET_SIGNS_RETRO = {
    'Марс': 'Овен',
    'Юпитер': 'Рыбы',
    'Сатурн': 'Водолей',
    'Уран': 'Козерог',
    'Нептун': 'Стрелец',
    'Плутон': 'Скорпион',
}


# ==============================================================================
# 2. ПРАВИЛА УПРАВЛЕНИЯ ДОМАМИ
# ==============================================================================

"""
4 ПРАВИЛА УПРАВЛЕНИЯ ДОМАМИ:

┌─────────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО 1: ЗНАК НА КУСПИДЕ → планета УПРАВЛЯЕТ домом                        │
│                                                                             │
│   Пример: Куспид I дома = 01°16' Льва → Солнце управляет I домом           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО 2: ВКЛЮЧЁННЫЙ ЗНАК → планета СОУПРАВЛЯЕТ домом                      │
│                                                                             │
│   Включённый = знак полностью внутри дома (не касается ни одного куспида)  │
│   Пример: Дом от 5° Весов до 10° Стрельца → Скорпион включён               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО 3: ЗНАК ВХОДИТ > 13.5° → планета СОУПРАВЛЯЕТ домом                  │
│                                                                             │
│   Если знак занимает более 13.5° в доме — его управитель соуправляет       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО 4: ЗНАК ЗАНИМАЕТ > 50% ДОМА → планета СОУПРАВЛЯЕТ домом             │
│                                                                             │
│   Пример: Дом = 20°, Дева занимает 12° (60%) → Меркурий соуправляет        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ПРАВИЛО 5 (РЕТРО): Ретроградная планета управляет ДВУМЯ знаками             │
│                                                                             │
│   Юпитер R → управляет Стрельцом + Рыбами                                  │
│   Сатурн R → управляет Козерогом + Водолеем                                │
│   и т.д.                                                                    │
└─────────────────────────────────────────────────────────────────────────────┘

СПЕЦИАЛЬНЫЕ ТОЧКИ:
- Лилит: ВСЕГДА связана с VIII домом (добавляется к управлению)
- Северный узел: НЕ управляет знаками, только дом положения
"""

HOUSE_RULERSHIP_RULES = {
    'rule_1_cusp': 'Знак на куспиде дома → УПРАВИТЕЛЬ',
    'rule_2_included': 'Включённый знак (весь внутри дома) → СОУПРАВИТЕЛЬ',
    'rule_3_over_13_5': 'Знак входит более 13.5° → СОУПРАВИТЕЛЬ',
    'rule_4_over_50_pct': 'Знак занимает более 50% дома → СОУПРАВИТЕЛЬ',
    'rule_5_retro': 'Ретро-планета добавляет второй знак управления',
}

# Специальные точки
SPECIAL_POINTS_RULES = {
    'Лилит': {
        'always_rules': [8],  # Лилит ВСЕГДА связана с VIII домом
        'description': 'Чёрная Луна, добавляет VIII дом к управлению',
    },
    'Северный узел': {
        'always_rules': [],   # Не управляет знаками
        'description': 'Только дом положения, без управления',
    },
}


# ==============================================================================
# 3. МАТРИЦА ОРБИСОВ ПО ШЕСТОПАЛОВУ
# ==============================================================================

"""
ОРБИСЫ ЗАВИСЯТ ОТ ПАРЫ ПЛАНЕТ!

Матрица орбисов (симметричная):

           ☉    ☽    ☿    ♀    ♂    ♃    ♄    ♅    ♆    ♇    ⚸
    ☉     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ☽     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ☿     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♀     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♂     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♃     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♄     9.0  9.0  9.0  9.0  9.0  9.0  9.0  9.0  9.0  7.0  5.0
    ♅     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♆     8.5  8.5  8.5  8.5  8.5  8.5  9.0  8.5  8.5  6.5  5.0
    ♇     6.5  6.5  6.5  6.5  6.5  6.5  7.0  6.5  6.5  6.5  5.0
    ⚸     5.0  5.0  5.0  5.0  5.0  5.0  5.0  5.0  5.0  5.0  5.0

ОСОБЕННОСТИ:
- Сатурн: увеличенный орбис 9° со всеми планетами
- Плутон: уменьшенный орбис 6.5° (7° с Сатурном)
- Лилит: минимальный орбис 5° со всеми
"""

# Порядок планет для индексации матрицы
ORB_PLANET_ORDER = [
    'Солнце', 'Луна', 'Меркурий', 'Венера', 'Марс',
    'Юпитер', 'Сатурн', 'Уран', 'Нептун', 'Плутон', 'Лилит'
]

# Матрица орбисов
ORB_MATRIX = [
    # Солн  Луна  Мерк  Вен   Марс  Юпит  Сат   Уран  Непт  Плут  Лилит
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Солнце
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Луна
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Меркурий
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Венера
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Марс
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Юпитер
    [9.0,  9.0,  9.0,  9.0,  9.0,  9.0,  9.0,  9.0,  9.0,  7.0,  5.0],  # Сатурн
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Уран
    [8.5,  8.5,  8.5,  8.5,  8.5,  8.5,  9.0,  8.5,  8.5,  6.5,  5.0],  # Нептун
    [6.5,  6.5,  6.5,  6.5,  6.5,  6.5,  7.0,  6.5,  6.5,  6.5,  5.0],  # Плутон
    [5.0,  5.0,  5.0,  5.0,  5.0,  5.0,  5.0,  5.0,  5.0,  5.0,  5.0],  # Лилит
]


def get_orb_for_planets(planet1: str, planet2: str) -> float:
    """Получить орбис для пары планет из матрицы."""
    try:
        idx1 = ORB_PLANET_ORDER.index(planet1)
        idx2 = ORB_PLANET_ORDER.index(planet2)
        return ORB_MATRIX[idx1][idx2]
    except (ValueError, IndexError):
        return 5.0  # Стандартный орбис для неизвестных


# ==============================================================================
# 4. ЗЛЫЕ И ДОБРЫЕ ПЛАНЕТЫ
# ==============================================================================

"""
ЗЛЫЕ ПЛАНЕТЫ (малефики) — 1:
  Марс, Сатурн, Уран, Нептун, Плутон, Лилит

ДОБРЫЕ ПЛАНЕТЫ (бенефики) — 0:
  Солнце, Луна, Меркурий, Венера, Юпитер

Используется для интерпретации соединений (±):
- Соединение двух добрых = благоприятно
- Соединение двух злых = напряжённо
- Соединение доброй и злой = смешанно
"""

MALEFIC_PLANETS = {
    'Солнце': False,        # 0 — добрая
    'Луна': False,          # 0 — добрая
    'Меркурий': False,      # 0 — добрая
    'Венера': False,        # 0 — добрая
    'Марс': True,           # 1 — злая
    'Юпитер': False,        # 0 — добрая
    'Сатурн': True,         # 1 — злая
    'Уран': True,           # 1 — злая
    'Нептун': True,         # 1 — злая
    'Плутон': True,         # 1 — злая
    'Лилит': True,          # 1 — злая
    'Северный узел': False, # 0 — нейтральная
}


# ==============================================================================
# 5. АСПЕКТЫ И ИХ ПРИРОДА
# ==============================================================================

"""
ОСНОВНЫЕ АСПЕКТЫ:

┌──────────────┬────────┬─────────┬──────────────────────────────┐
│ Аспект       │ Угол   │ Природа │ Описание                     │
├──────────────┼────────┼─────────┼──────────────────────────────┤
│ Соединение   │ 0°     │ ±       │ Нейтральный (зависит от пл.) │
│ Секстиль     │ 60°    │ +       │ Гармоничный                  │
│ Квадратура   │ 90°    │ -       │ Напряжённый                  │
│ Тригон       │ 120°   │ +       │ Гармоничный                  │
│ Оппозиция    │ 180°   │ -       │ Напряжённый                  │
└──────────────┴────────┴─────────┴──────────────────────────────┘

ПРИРОДА В ФОРМУЛАХ:
  + = гармоничное пересечение домов (благоприятные события)
  - = напряжённое пересечение домов (проблемные события)
  ± = зависит от планет в соединении
"""

ASPECTS = {
    0: {
        'name': 'Соединение',
        'symbol': '☌',
        'nature': '±',
    },
    60: {
        'name': 'Секстиль',
        'symbol': '⚹',
        'nature': '+',
    },
    90: {
        'name': 'Квадратура',
        'symbol': '□',
        'nature': '-',
    },
    120: {
        'name': 'Тригон',
        'symbol': '△',
        'nature': '+',
    },
    180: {
        'name': 'Оппозиция',
        'symbol': '☍',
        'nature': '-',
    },
}


# ==============================================================================
# 6. СХОДЯЩИЙСЯ / РАСХОДЯЩИЙСЯ АСПЕКТ
# ==============================================================================

"""
СХОДЯЩИЙСЯ (Сх) — планеты движутся К точному аспекту (орбис уменьшается)
РАСХОДЯЩИЙСЯ (Расх) — планеты удаляются ОТ точного аспекта (орбис увеличивается)

АЛГОРИТМ ОПРЕДЕЛЕНИЯ:

1. Вычислить разницу долгот: diff = lon1 - lon2
2. Вычислить относительную скорость: rel_speed = speed1 - speed2
3. Определить, к какому точному аспекту ближе
4. Проверить, уменьшается или увеличивается расстояние до точного аспекта

Для СОЕДИНЕНИЯ (0°):
  - Если diff > 0 и rel_speed < 0 → Сходящийся
  - Если diff < 0 и rel_speed > 0 → Сходящийся
  - Иначе → Расходящийся

Для других аспектов — аналогично, с учётом угла аспекта.

ВАЖНОСТЬ:
- Сходящийся аспект СИЛЬНЕЕ — событие ещё впереди
- Расходящийся аспект слабее — событие уже в прошлом
"""


# ==============================================================================
# 7. АСПЕКТЫ К КУСПИДАМ ДОМОВ
# ==============================================================================

"""
АСПЕКТЫ ПЛАНЕТ К КУСПИДАМ:

- Учитываются ТОЛЬКО СОЕДИНЕНИЯ (☌)
- Орбис: 1° (строгий)
- Формула: добавляется связь с домом куспида

Пример:
  Меркурий R в 21°22' Льва
  Куспид II дома = 22°04' Льва
  Разница = 00°41'49" (< 1°)

  → Меркурий ☌ II (соединение с куспидом II дома)
  → Формула: 1 (2 3 11) ± 2 (2)
"""

CUSP_ASPECT_ORB = 1.0  # Орбис для аспектов к куспидам


# ==============================================================================
# 8. ФОРМУЛА СОБЫТИЯ (структура вывода)
# ==============================================================================

"""
СТРУКТУРА ФОРМУЛЫ:

  Планетал  Аспект  Планетал  Орбис      Сх/Расх  Формула
  ──────────────────────────────────────────────────────────
  ☉л        ☌       ☿лR       07°02'09"  Сх       4 (3 4) ± 4 (1 4 5)

РАСШИФРОВКА:

  ☉л = Солнце прямое (л = локальная карта)
  ☿лR = Меркурий ретроградный

  Формула: ПОЗИЦИЯ (УПРАВЛЕНИЕ) ПРИРОДА ПОЗИЦИЯ (УПРАВЛЕНИЕ)

  4 (3 4) = Солнце в 4 доме, управляет 3 и 4 домами
  4 (1 4 5) = Меркурий в 4 доме, управляет 1, 4, 5 домами

  ± = природа соединения (нейтральная)
  + = гармоничный аспект (секстиль, тригон)
  - = напряжённый аспект (квадратура, оппозиция)

ОСОБЫЕ СЛУЧАИ:

  1. Северный узел НЕ управляет знаками:
     ☉л □ ☊лR  00°43'30"  Расх  4 (3 4) - 12
     (только номер дома БЕЗ скобок)

  2. Аспекты к куспидам домов:
     ♃лR ☌ X  00°12'39"  9 (7 10 11) ± 10
     (куспид = только номер дома)

СВЯЗИ ДОМОВ (какие пары домов связывает аспект):

  Все дома П1 × Все дома П2 (кроме одинаковых)

  Пример: ☉л ☌ ☿лR  4 (3 4) ± 4 (1 4 5)
  П1: дом 4 + управление [3, 4] = {3, 4}
  П2: дом 4 + управление [1, 4, 5] = {1, 4, 5}

  Связи: 3±1, 3±4, 3±5, 4±1, 4±5
  (4±4 исключается как одинаковый)
"""


# ==============================================================================
# 9. ПРАВИЛО ТРЁХ УКАЗАНИЙ
# ==============================================================================

"""
ПРАВИЛО ТРЁХ УКАЗАНИЙ:

Для реализации события нужно МИНИМУМ 3 повторения формулы.

Пример: Формула брака = I-VII

Если в карте есть:
  - Солнце △ Венера → связь 1-7 (+1)
  - Марс ☍ Юпитер → связь 1-7 (+1)
  - Луна ⚹ Сатурн → связь 1-7 (+1)

  Итого: 3 указания → формула брака АКТИВНА

Подсчёт:
  - Считаем отдельно + (гармоничные) и - (напряжённые)
  - Если + > - → благоприятная реализация
  - Если - > + → проблемная реализация
  - Если + = - → смешанная реализация
"""


# ==============================================================================
# 10. ПРИМЕР ПОЛНОГО РАСЧЁТА
# ==============================================================================

"""
ПРИМЕР: ЛОКАЛЬНАЯ КАРТА
  Рождение: 07.08.1985 05:26:01, Белово (54.4165°N, 86.2976°E), TZ+8
  Проживание: ст. Раевская (44.8167°N, 37.5333°E)

ВАЖНО: По Шестопалову используется ЛОКАЛЬНАЯ КАРТА (релокация):
  - ПЛАНЕТЫ рассчитываются по месту РОЖДЕНИЯ (неизменны)
  - ДОМА рассчитываются по месту ПРОЖИВАНИЯ
  - Северный узел = MEAN NODE (средний, не истинный!)

ШАГИ РАСЧЁТА:

1. РАССЧИТАТЬ JULIAN DAY
   JD = datetime_to_julian(dt, timezone_hours=8)

2. РАССЧИТАТЬ ПОЗИЦИИ ПЛАНЕТ по месту рождения (Белово)
   Для каждой планеты: swe.calc_ut(jd, planet_id, flags)
   Получаем: долгота, скорость (для Сх/Расх), ретроградность

3. РАССЧИТАТЬ КУСПИДЫ ДОМОВ по месту проживания (Koch, Раевская)
   cusps, ascmc = swe.houses(jd, residence_lat, residence_lon, b'K')

   Результат для Раевской:
     ASC: 09°35' Близнецов
     MC:  11°55' Водолея

4. ОПРЕДЕЛИТЬ ДОМ ПОЛОЖЕНИЯ КАЖДОЙ ПЛАНЕТЫ
   house = get_planet_house(longitude, cusps)

5. ОПРЕДЕЛИТЬ ДОМА УПРАВЛЕНИЯ ДЛЯ КАЖДОЙ ПЛАНЕТЫ
   По 4 правилам + ретро (см. раздел 2)

   Пример для Меркурия R в локальной карте:
     - Меркурий управляет Близнецами и Девой
     - Близнецы на куспиде I → управляет I
     - Лев на куспиде IV, Меркурий в Льве → стоит в IV
     - Дева на куспиде V → управляет V

     Итого: Меркурий R → H4 упр(1 4 5)

6. НАЙТИ АСПЕКТЫ МЕЖДУ ПЛАНЕТАМИ
   Для каждой пары: find_aspect(lon1, lon2, planet1, planet2, speed1, speed2)
   - Проверить орбис по матрице Шестопалова
   - Определить Сх/Расх по скоростям

7. НАЙТИ АСПЕКТЫ К КУСПИДАМ (только соединения, орбис 1°)
   Для каждой планеты и каждого куспида

8. ВЫВЕСТИ ФОРМУЛЫ СОБЫТИЙ
   Формат: Планетал Аспект Планетал Орбис Сх/Расх Формула

═══════════════════════════════════════════════════════════════════════════════

РЕЗУЛЬТАТ ЛОКАЛЬНОЙ КАРТЫ (ст. Раевская):

☉л   ☌ ☿лR   07°02'09"  Сх    4 (3 4) ± 4 (1 4 5)
☉л   ☌ ♂л    06°08'16"  Расх  4 (3 4) ± 3 (6)
☉л   ☍ ♃лR   02°37'00"  Расх  4 (3 4) - 9 (7 10 11)
☉л   □ ♄л    07°14'59"  Сх    4 (3 4) - 6 (8 9)
☉л   △ ♅лR   00°15'49"  Расх  4 (3 4) + 7 (8 9 10)
☉л   □ ☊лR   00°43'30"  Расх  4 (3 4) - 12
☽л   △ ☿лR   02°34'38"  Расх  11 (2 3) + 4 (1 4 5)
☽л   △ ♆лR   07°14'21"  Сх    11 (2 3) + 7 (7 10 11)
☿лR  □ ♄л    00°12'50"  Расх  4 (1 4 5) - 6 (8 9)
☿лR  △ ♅лR   07°17'58"  Сх    4 (1 4 5) + 7 (8 9 10)
♀л   ☍ ♆лR   03°58'43"  Расх  2 (5 12) - 7 (7 10 11)
♀л   △ ♇л    03°03'26"  Расх  2 (5 12) + 5 (11)
♀л   ⚹ ⚸л    02°09'29"  Сх    2 (5 12) + 12 (8)
♂л   ☍ ♃лR   03°31'16"  Сх    3 (6) - 9 (7 10 11)
♂л   △ ♅лR   05°52'27"  Сх    3 (6) + 7 (8 9 10)
♂л   □ ♇л    06°05'16"  Расх  3 (6) - 5 (11)
♂л   □ ⚸л    00°52'20"  Расх  3 (6) - 12 (8)
♃лR  ⚹ ♅лR   02°21'10"  Расх  9 (7 10 11) + 7 (8 9 10)
♃лR  □ ⚸л    04°23'37"  Сх    9 (7 10 11) - 12 (8)
♃лR  □ ☊лR   01°53'29"  Расх  9 (7 10 11) - 12
♆лR  ⚹ ♇л    00°55'17"  Расх  7 (7 10 11) + 5 (11)
♃лR  ☌ X     00°12'39"        9 (7 10 11) ± 10

═══════════════════════════════════════════════════════════════════════════════
"""


# ==============================================================================
# ВСПОМОГАТЕЛЬНЫЕ КОНСТАНТЫ
# ==============================================================================

# Знаки зодиака
ZODIAC_SIGNS = [
    'Овен', 'Телец', 'Близнецы', 'Рак', 'Лев', 'Дева',
    'Весы', 'Скорпион', 'Стрелец', 'Козерог', 'Водолей', 'Рыбы'
]

# Символы планет
PLANET_SYMBOLS = {
    'Солнце': '☉', 'Луна': '☽', 'Меркурий': '☿', 'Венера': '♀',
    'Марс': '♂', 'Юпитер': '♃', 'Сатурн': '♄', 'Уран': '♅',
    'Нептун': '♆', 'Плутон': '♇', 'Северный узел': '☊', 'Лилит': '⚸'
}

# Римские цифры для домов
ROMAN_NUMERALS = {
    1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI',
    7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X', 11: 'XI', 12: 'XII'
}

# Порядок планет по удалению от Солнца
PLANET_ORDER = [
    'Солнце', 'Луна', 'Меркурий', 'Венера', 'Марс',
    'Юпитер', 'Сатурн', 'Уран', 'Нептун', 'Плутон',
    'Северный узел', 'Лилит'
]

# ID планет в Swiss Ephemeris
PLANETS_SWE = {
    swe.SUN: 'Солнце',
    swe.MOON: 'Луна',
    swe.MERCURY: 'Меркурий',
    swe.VENUS: 'Венера',
    swe.MARS: 'Марс',
    swe.JUPITER: 'Юпитер',
    swe.SATURN: 'Сатурн',
    swe.URANUS: 'Уран',
    swe.NEPTUNE: 'Нептун',
    swe.PLUTO: 'Плутон',
    swe.MEAN_NODE: 'Северный узел',  # По Шестопалову используется MEAN NODE
    swe.MEAN_APOG: 'Лилит',
}


# ==============================================================================
# 11. ТРАНЗИТЫ (ТРАНЗИТ ПЛАНЕТ К НАТАЛЬНЫМ ПЛАНЕТАМ)
# ==============================================================================

"""
ТРАНЗИТЫ ПО ШЕСТОПАЛОВУ:

Транзит — это аспект между ТРАНЗИТНОЙ планетой (текущее положение)
и НАТАЛЬНОЙ планетой (положение при рождении).

ФОРМАТ ВЫВОДА ТРАНЗИТА:
  ☽т ♂ ☽н 11.01.2026 01:49:58 4 (10 12) - 10 (12)

  Расшифровка:
  ☽т        — транзитная Луна (т = транзит)
  ♂         — символ аспекта (♂ = оппозиция, см. ниже)
  ☽н        — натальная Луна (н = натал)
  11.01.2026 01:49:58 — дата/время ТОЧНОГО аспекта (орбис = 0)
  4 (10 12) — формула транзитной планеты: дом 4, управляет 10, 12
  -         — природа аспекта (- = напряжённый)
  10 (12)   — формула натальной планеты: дом 10, управляет 12

СИМВОЛЫ АСПЕКТОВ (программа Altair):
┌──────────────┬────────┬─────────────────────┐
│ Символ       │ Угол   │ Название            │
├──────────────┼────────┼─────────────────────┤
│ * (звёздочка)│ 60°    │ Секстиль (+)        │
│ □            │ 90°    │ Квадратура (-)      │
│ △            │ 120°   │ Тригон (+)          │
│ ♂            │ 180°   │ Оппозиция (-)       │
│ ☌            │ 0°     │ Соединение (±)      │
└──────────────┴────────┴─────────────────────┘

ВАЖНО: В Altair символ ♂ означает ОППОЗИЦИЮ, не Марс!

================================================================================
МЕТОДОЛОГИЯ РАСЧЁТА ТРАНЗИТА:
================================================================================

1. ДОМ ТРАНЗИТНОЙ ПЛАНЕТЫ:
   Определяется по НАТАЛЬНЫМ куспидам (в какой натальный дом попадает)

   Транзитная Луна в 215.16° (5° Скорпиона)
   Натальные куспиды: H4 начинается с 183.44° (Весы)
   → Транзитная Луна в IV натальном доме

2. УПРАВЛЕНИЕ ТРАНЗИТНОЙ ПЛАНЕТЫ:
   Транзитная планета "несёт" формулу своей НАТАЛЬНОЙ версии!

   Формула = дом НАТАЛЬНОЙ планеты + управление НАТАЛЬНОЙ планеты

   Пример для транзитной Луны:
   - Натальная Луна в H10, управляет H12
   - Формула транзитной = (10 12)

   Итого: ☽т = 4 (10 12)
   - 4 — дом транзитной Луны по натальным куспидам
   - (10 12) — дом и управление натальной Луны

3. ФОРМУЛА НАТАЛЬНОЙ ПЛАНЕТЫ:
   Дом положения + управление по наталу.
   ВАЖНО: Дом положения НЕ включается в скобки (он уже указан перед ними).

   Пример: Натальная Луна в H10, управляет H12
   → 10 (12) — дом 10, управление только (12)

4. ПРИРОДА АСПЕКТА:
   + = секстиль (60°), тригон (120°)
   - = квадратура (90°), оппозиция (180°)
   ± = соединение (0°)

================================================================================
ЧАСОВЫЕ ПОЯСА:
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ НАТАЛЬНАЯ КАРТА:                                                            │
│   Белово 1985 год → TZ+8 (декретное время)                                 │
│   Для рождённых до 1991 — учитывать декретное время!                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ТРАНЗИТНЫЕ КУСПИДЫ:                                                         │
│   Белово сейчас → TZ+7 (Кузбасс, с 2010 года)                              │
│   Для расчёта куспидов МОМЕНТА транзита используем текущий TZ              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ОТОБРАЖЕНИЕ ВРЕМЕНИ:                                                        │
│   Может быть TZ+3 (Москва) или TZ+7 (локальное) — настройка пользователя   │
└─────────────────────────────────────────────────────────────────────────────┘

ПРИМЕР ПРЕОБРАЗОВАНИЯ:
  Точный аспект: 10.01.2026 18:49:58 UTC
  → TZ+3: 10.01.2026 21:49:58 (Москва) — НЕ СОВПАДАЕТ С ДАТОЙ
  → TZ+7: 11.01.2026 01:49:58 (Белово) — ЭТАЛОН

================================================================================
АЛГОРИТМ ПОИСКА ТОЧНОГО АСПЕКТА:
================================================================================

1. Определить период поиска (например, 7 дней)

2. Для каждой пары (транзитная планета, натальная планета):

   A) Получить координату натальной планеты (неизменна)

   B) Для транзитной планеты — искать моменты точного аспекта
      методом бинарного поиска:

      - Шаг 1: Грубый проход (шаг 6 часов)
      - Шаг 2: При обнаружении смены знака орбиса — уточнение
      - Шаг 3: Бинарный поиск до точности 1 минута

   C) Проверить, что орбис в момент точного аспекта < 0.01°

3. Для каждого найденного точного аспекта:

   A) Рассчитать дом транзитной планеты по НАТАЛЬНЫМ куспидам

   B) Управление = формула НАТАЛЬНОЙ версии этой планеты:
      - Дом натальной планеты + её управление по натальным куспидам

   C) Сформировать формулу транзитной: дом_транзита (натал_формула)

================================================================================
ПРИМЕР ПОЛНОГО РАСЧЁТА ТРАНЗИТА:
================================================================================

Данные:
  Натал: 07.08.1985 05:26:01, Белово (54.4165°N, 86.2976°E), TZ+8
  Транзит: 12.01.2026, TZ+7 (текущий TZ Белово)

НАТАЛЬНЫЕ ДАННЫЕ:
  Натальная Луна:
    - Координата: 23.95° Овна
    - Дом: H10
    - Управление: H12 (куспид H12 в Раке)
    - Формула натальной: 10 (12)

ПОИСК ТРИГОНА (120°) Луны к Венере:
  Натальная Венера: 5.17° Рака, H11, упр(4 10)
  Тригон = 120° → ищем транзитную Луну в 5.17° + 120° = 125.17° (Скорпион)

Найден точный аспект:
  12.01.2026 04:17:59 TZ+7 (UTC 11.01.2026 21:17:59)

Расчёт формулы транзитной Луны:
  Транзитная Луна = 215.16° (5° Скорпиона)

  1. Дом по НАТАЛЬНЫМ куспидам:
     H4 = 183.44° (Весы), H5 = 247.11° (Стрелец)
     Луна (215.16°) между H4 и H5 → дом = 4

  2. Управление = формула НАТАЛЬНОЙ Луны:
     Натальная Луна: дом 10 + управление [12] = (10 12)

  Формула транзитной: 4 (10 12)

Формула натальной Венеры:
  Дом: 11, Управление: (4 10)
  Формула: 11 (4 10)

ИТОГОВЫЙ ВЫВОД:
  ☽т △ ♀н 12.01.2026 04:17:59 4 (10 12) + 11 (4 10)

================================================================================
ПРИМЕЧАНИЯ:
================================================================================

1. Северный узел: используется MEAN NODE (swe.MEAN_NODE), не TRUE NODE

2. Орбисы для транзитов: те же, что для натальных аспектов (матрица из раздела 3)

3. Сходящийся/Расходящийся: можно добавить в вывод, но в базовом формате не указывается

4. Система домов: Koch (b'K') для всех расчётов

5. Для быстрых планет (Луна, Солнце, Меркурий, Венера, Марс):
   Может быть несколько точных аспектов в периоде

6. Для медленных планет (Юпитер, Сатурн, Уран, Нептун, Плутон):
   Обычно один аспект действует длительно

================================================================================
"""

# Символы аспектов Altair
ALTAIR_ASPECT_SYMBOLS = {
    0: '☌',     # Соединение
    60: '*',    # Секстиль (звёздочка)
    90: '□',    # Квадратура
    120: '△',   # Тригон
    180: '♂',   # Оппозиция (НЕ Марс!)
}

# Суффиксы для транзитов
TRANSIT_SUFFIX = 'т'  # транзитная планета
NATAL_SUFFIX = 'н'    # натальная планета
